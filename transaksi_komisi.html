<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Scanner - Delta Spa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Urbanist', sans-serif; background-color: #020617; color: #f8fafc; overflow-x: hidden; }
        .card { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(212, 175, 55, 0.1); }
        .sidebar { background: #0f172a; border-right: 1px solid rgba(212, 175, 55, 0.1); }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 14px 20px; border-radius: 16px; color: #94a3b8; transition: 0.3s; margin-bottom: 8px; font-weight: 500; }
        .nav-link:hover { background: rgba(212, 175, 55, 0.05); color: #d4af37; }
        .nav-link.active { background: linear-gradient(135deg, #d4af37 0%, #a67c00 100%); color: white; }
        .gold-text { color: #d4af37; }
        .input-field { background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); color: white; width: 100%; padding: 12px 20px; border-radius: 12px; outline: none; transition: 0.3s; }
        .input-field:focus { border-color: #d4af37; box-shadow: 0 0 10px rgba(212, 175, 55, 0.1); }
        
        #camera-wrapper { position: relative; width: 100%; max-width: 400px; aspect-ratio: 1/1; margin: 0 auto; border-radius: 50%; overflow: hidden; border: 4px solid rgba(212, 175, 55, 0.3); box-shadow: 0 0 50px rgba(212, 175, 55, 0.1); transition: 0.5s; }
        #video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .scan-ring { position: absolute; inset: 0; border: 2px solid #d4af37; border-radius: 50%; animation: pulse 2s infinite; opacity: 0.5; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(1.1); opacity: 0; } }
        
        .locked-area { display: none; opacity: 0; transform: translateY(20px); transition: 0.5s ease; }
        .unlocked-area { display: block; opacity: 1; transform: translateY(0); }

        .loader-overlay { position: fixed; inset: 0; background: #020617; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.5s; }
    </style>
</head>
<body class="min-h-screen flex">
    <!-- Full Screen Loader -->
    <div id="initial-loader" class="loader-overlay">
        <h1 class="text-3xl font-black italic gold-text tracking-tighter uppercase mb-6">Delta<span class="text-white">Spa</span></h1>
        <div class="w-48 h-1.5 bg-white/10 rounded-full overflow-hidden mb-4">
            <div id="load-progress" class="h-full bg-[#d4af37] w-0 transition-all duration-300"></div>
        </div>
        <p id="load-status" class="text-[10px] font-bold tracking-[0.3em] text-slate-500 uppercase">Menyiapkan Database Wajah...</p>
    </div>

    <!-- Sidebar -->
    <aside class="w-72 shrink-0 flex flex-col sidebar hidden md:flex">
        <div class="p-8">
            <h1 class="text-2xl font-black italic gold-text tracking-tighter uppercase">Delta<span class="text-white">Spa</span></h1>
            <p class="text-[10px] text-slate-500 font-bold tracking-widest uppercase mt-1">Finex Pos - Bali</p>
        </div>
        <nav class="flex-1 px-4">
            <a href="dashboard.html" class="nav-link"><i class="fa-solid fa-chart-pie w-5"></i> Dashboard</a>
            <a href="pendaftaran_driver.html" class="nav-link"><i class="fa-solid fa-id-card w-5"></i> Registrasi Driver</a>
            <a href="transaksi_komisi.html" class="nav-link active"><i class="fa-solid fa-face-viewfinder w-5"></i> Input Transaksi</a>
            <a href="riwayat_transaksi.html" class="nav-link"><i class="fa-solid fa-clock-rotate-left w-5"></i> Riwayat & Komisi</a>
        </nav>
    </aside>

    <main class="flex-1 p-6 md:p-10 overflow-y-auto">
        <div class="max-w-3xl mx-auto">
            <!-- Scan Section -->
            <div id="scan-view" class="text-center mb-10 mt-10">
                <h2 id="welcome-title" class="text-3xl font-bold mb-2">Arahkan Wajah Anda</h2>
                <p id="instruction-text" class="text-slate-400 text-sm mb-12">Sistem Finex Pos mendeteksi identitas secara otomatis...</p>

                <div id="camera-wrapper">
                    <video id="video" autoplay muted playsinline></video>
                    <div class="scan-ring"></div>
                </div>
            </div>

            <!-- Form Section (Initially Hidden) -->
            <form id="form-transaksi" class="locked-area card p-6 md:p-8 rounded-[2.5rem] space-y-6">
                <div class="flex items-center gap-6 p-6 rounded-3xl bg-white/5 border border-white/10 mb-8">
                    <div class="relative">
                        <img id="detected-photo" src="" class="w-20 h-20 rounded-2xl object-cover border-2 border-[#d4af37]">
                        <div class="absolute -bottom-2 -right-2 bg-green-500 text-white p-1.5 rounded-full text-[10px]">
                            <i class="fa-solid fa-check"></i>
                        </div>
                    </div>
                    <div class="flex-1">
                        <p class="text-[10px] text-slate-500 uppercase font-bold tracking-widest mb-1">Identitas Terverifikasi</p>
                        <h4 id="detected-name" class="text-2xl font-bold text-white">Bapak/Ibu</h4>
                        <p id="detected-id" class="text-sm gold-text font-medium italic"></p>
                    </div>
                    <button type="button" onclick="location.reload()" class="p-3 bg-white/5 hover:bg-red-500/10 text-slate-500 hover:text-red-400 rounded-xl transition-all">
                        <i class="fa-solid fa-rotate-right"></i>
                    </button>
                </div>

                <input type="hidden" id="driver-id">
                <input type="hidden" id="driver-name">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-3 ml-1">Kategori Tamu</label>
                        <select id="guest-category" class="input-field" required>
                            <option value="Lokal">Tamu Lokal</option>
                            <option value="Asing">Tamu Asing</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-3 ml-1">Pilih Layanan</label>
                        <select id="service-select" class="input-field" required>
                            <option value="">-- Pilih Paket --</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-3 ml-1">Jumlah Tamu (Pax)</label>
                        <input type="number" id="guest-count" min="1" value="1" class="input-field" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-3 ml-1">No. Kamar / Catatan</label>
                        <input type="text" id="transaction-note" placeholder="Contoh: Room 302" class="input-field">
                    </div>
                </div>

                <!-- Preview Area -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 py-4">
                    <div class="bg-slate-900/50 p-4 rounded-2xl border border-slate-800 text-center">
                        <p class="text-[9px] text-slate-500 uppercase font-bold tracking-widest mb-1">Total Bill</p>
                        <h3 id="display-bill" class="text-lg font-black text-white">Rp 0</h3>
                    </div>
                    <div class="bg-[#d4af37]/5 p-4 rounded-2xl border border-[#d4af37]/20 text-center">
                        <p class="text-[9px] text-slate-500 uppercase font-bold tracking-widest mb-1">Komisi</p>
                        <h3 id="display-commission" class="text-lg font-black gold-text">Rp 0</h3>
                    </div>
                    <div class="bg-blue-500/5 p-4 rounded-2xl border border-blue-500/20 text-center">
                        <p class="text-[9px] text-slate-500 uppercase font-bold tracking-widest mb-1">Poin Baru</p>
                        <h3 id="display-points" class="text-lg font-black text-blue-400">0 Pts</h3>
                    </div>
                </div>

                <button type="submit" id="btn-submit" class="w-full bg-gradient-to-r from-[#d4af37] to-[#a67c00] text-white font-bold py-5 rounded-2xl shadow-lg transition-all active:scale-[0.98] flex items-center justify-center gap-3">
                    <i class="fa-solid fa-paper-plane"></i>
                    <span>SIMPAN TRANSAKSI</span>
                </button>
            </form>
        </div>
    </main>

    <script>
        const SUPABASE_URL = "https://qdxchvogaxiibzqvuupf.supabase.co"; 
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkeGNodm9nYXhpaWJ6cXZ1dXBmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxODE5NTIsImV4cCI6MjA4NTc1Nzk1Mn0.8U_zk81b6wFfdZdPRupk5KSk3g39nOPs8SpZVkWbqkc";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let faceMatcher = null;
        let videoStream = null;
        let allDrivers = [];

        async function initApp() {
            const statusText = document.getElementById('load-status');
            const progressBar = document.getElementById('load-progress');

            try {
                // 1. Load AI Models
                statusText.innerText = "Memuat Modul Biometrik...";
                progressBar.style.width = "30%";
                const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
                await Promise.all([
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);

                // 2. Fetch Data
                statusText.innerText = "Mengambil Data Driver...";
                progressBar.style.width = "50%";
                const [{ data: drivers }, { data: services }] = await Promise.all([
                    supabaseClient.from('drivers').select('*'),
                    supabaseClient.from('services').select('*').order('name')
                ]);

                allDrivers = drivers || [];
                
                // Populate Services Select
                const select = document.getElementById('service-select');
                services?.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.dataset.commission = s.commission;
                    opt.dataset.price = s.price || 0;
                    opt.textContent = s.name;
                    select.appendChild(opt);
                });

                // 3. Pre-train Face Matcher
                statusText.innerText = "Mempelajari Wajah Driver...";
                progressBar.style.width = "80%";
                await trainAI();

                // 4. Cleanup Loader
                progressBar.style.width = "100%";
                setTimeout(() => {
                    document.getElementById('initial-loader').style.opacity = '0';
                    setTimeout(() => document.getElementById('initial-loader').style.display = 'none', 500);
                    startCamera();
                }, 500);

            } catch (err) {
                console.error(err);
                alert("Gagal menginisialisasi sistem Finex Pos.");
            }
        }

        async function trainAI() {
            const labeledDescriptors = [];

            // Memproses semua foto driver sekaligus agar scan nanti jadi instant
            const descriptorsPromises = allDrivers.map(async (driver) => {
                try {
                    const img = await faceapi.fetchImage(driver.photo_url);
                    const detection = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
                    if (detection) {
                        return new faceapi.LabeledFaceDescriptors(driver.driver_id, [detection.descriptor]);
                    }
                } catch (e) {
                    console.warn(`Error processing ${driver.name}`);
                }
                return null;
            });

            const results = await Promise.all(descriptorsPromises);
            const finalDescriptors = results.filter(res => res !== null);

            if (finalDescriptors.length > 0) {
                faceMatcher = new faceapi.FaceMatcher(finalDescriptors, 0.55);
            }
        }

        async function startCamera() {
            const video = document.getElementById('video');
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user", width: 480, height: 480 } 
                });
                video.srcObject = videoStream;
                runRecognitionLoop();
            } catch (err) {
                alert("Izin kamera diperlukan untuk scanner wajah.");
            }
        }

        async function runRecognitionLoop() {
            const video = document.getElementById('video');
            
            // Loop cepat: deteksi wajah setiap 400ms
            const scanInterval = setInterval(async () => {
                if (!faceMatcher) return;

                const detection = await faceapi.detectSingleFace(video).withFaceLandmarks().withFaceDescriptor();
                
                if (detection) {
                    const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
                    
                    if (bestMatch.label !== 'unknown') {
                        clearInterval(scanInterval);
                        onFaceFound(bestMatch.label);
                    }
                }
            }, 400);
        }

        function onFaceFound(driverId) {
            const driver = allDrivers.find(d => d.driver_id === driverId);
            if (!driver) return;

            // Suara / Notifikasi Visual
            document.getElementById('welcome-title').innerHTML = `Selamat Datang <span class="gold-text">Bapak/Ibu ${driver.name}</span>`;
            document.getElementById('instruction-text').innerText = "Wajah Terverifikasi!";
            
            // Isi Form Otomatis
            document.getElementById('driver-id').value = driver.driver_id;
            document.getElementById('driver-name').value = driver.name;
            document.getElementById('detected-name').innerText = driver.name;
            document.getElementById('detected-id').innerText = `NIK: ${driver.driver_id}`;
            document.getElementById('detected-photo').src = driver.photo_url;

            // Animasi Transisi dari Scanner ke Form
            setTimeout(() => {
                document.getElementById('camera-wrapper').style.transform = "scale(0.8)";
                document.getElementById('camera-wrapper').style.opacity = "0";
                setTimeout(() => {
                    document.getElementById('scan-view').style.display = "none";
                    document.getElementById('form-transaksi').className = "unlocked-area card p-6 md:p-8 rounded-[2.5rem] space-y-6";
                }, 400);
            }, 1000);
        }

        // Calculation Logic
        function updatePreview() {
            const select = document.getElementById('service-select');
            const opt = select.options[select.selectedIndex];
            const guests = parseInt(document.getElementById('guest-count').value) || 0;

            if (opt && opt.value) {
                const price = parseInt(opt.dataset.price);
                const comm = parseInt(opt.dataset.commission);

                document.getElementById('display-bill').innerText = `Rp ${(price * guests).toLocaleString('id-ID')}`;
                document.getElementById('display-commission').innerText = `Rp ${(comm * guests).toLocaleString('id-ID')}`;
                document.getElementById('display-points').innerText = `${guests} Pts`;
            }
        }

        document.getElementById('service-select').onchange = updatePreview;
        document.getElementById('guest-count').oninput = updatePreview;

        // Submit Logic
        document.getElementById('form-transaksi').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-spinner animate-spin"></i> MENYIMPAN...`;

            const select = document.getElementById('service-select');
            const opt = select.options[select.selectedIndex];
            const guests = parseInt(document.getElementById('guest-count').value);

            const payload = {
                driver_id: document.getElementById('driver-id').value,
                driver_name: document.getElementById('driver-name').value,
                service_id: select.value,
                service_name: opt.text,
                guest_category: document.getElementById('guest-category').value,
                massage_guests: guests,
                commission_amount: parseInt(opt.dataset.commission) * guests,
                points_earned: guests,
                total_massage_value: parseInt(opt.dataset.price) * guests,
                is_redeemed: false,
                notes: document.getElementById('transaction-note').value,
                created_at: new Date().toISOString()
            };

            const { error } = await supabaseClient.from('commissions').insert([payload]);

            if (!error) {
                showSuccessModal(payload.driver_name, guests);
            } else {
                alert("Gagal menyimpan: " + error.message);
                btn.disabled = false;
            }
        };

        function showSuccessModal(name, points) {
            const modal = document.createElement('div');
            modal.className = "fixed inset-0 flex items-center justify-center bg-black/95 z-[100] p-6";
            modal.innerHTML = `
                <div class="bg-slate-900 border border-[#d4af37]/30 p-10 rounded-[3rem] text-center max-w-sm w-full shadow-2xl scale-in">
                    <div class="w-24 h-24 bg-green-500/10 rounded-full flex items-center justify-center mx-auto mb-8">
                        <i class="fa-solid fa-check text-5xl text-green-500"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-white mb-2">Transaksi Berhasil</h3>
                    <p class="text-slate-400 text-sm mb-8">Data Bapak/Ibu <b>${name}</b> telah masuk ke sistem (+${points} Poin).</p>
                    <button onclick="location.reload()" class="w-full bg-gradient-to-r from-[#d4af37] to-[#a67c00] text-white font-bold py-5 rounded-2xl">SELESAI</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        window.onload = initApp;
    </script>
</body>
</html>
