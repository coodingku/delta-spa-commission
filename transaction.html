<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finex POS - Transaksi Terfokus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --gold: #D4AF37;
            --gold-dark: #AA8A2E;
            --bg-dark: #0A0C10;
            --card-dark: #161B22;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg-dark); 
            color: #E6EDF3;
            height: 100vh;
            overflow: hidden;
            margin: 0;
        }

        .glass-panel {
            background: rgba(22, 27, 34, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(212, 175, 55, 0.1);
        }

        .gold-gradient {
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
        }

        .input-elegant {
            background: #0D1117;
            border: 1px solid #30363D;
            transition: all 0.3s ease;
            color: white;
        }

        .input-elegant:focus {
            border-color: var(--gold);
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.15);
        }

        .step-content {
            display: none;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.4s ease;
        }

        .step-content.active {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }

        #camera-wrapper {
            position: relative;
            width: 260px;
            height: 260px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid #30363D;
            box-shadow: 0 0 40px rgba(0,0,0,0.5);
            background: #000;
        }

        #camera-view {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        .scanning-ring {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border: 4px solid var(--gold);
            border-radius: 50%;
            animation: pulse-ring 2s infinite;
            pointer-events: none;
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.98); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 0.3; }
            100% { transform: scale(0.98); opacity: 0.8; }
        }

        /* Modal Custom */
        #custom-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
    </style>
</head>
<body class="flex">

    <!-- Modal Notifikasi Manual -->
    <div id="custom-modal">
        <div class="bg-[#161B22] border border-[#30363D] p-8 rounded-[32px] max-w-sm w-full text-center">
            <div class="w-16 h-16 bg-red-500/10 text-red-500 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fa-solid fa-camera-slash text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-white mb-2">Kamera Diblokir</h3>
            <p id="modal-msg" class="text-slate-400 text-sm mb-8 leading-relaxed">Browser Anda memblokir akses kamera. Silakan klik ikon gembok di bar alamat (URL) dan aktifkan Kamera.</p>
            <button onclick="closeModal()" class="w-full py-4 rounded-2xl gold-gradient text-white font-bold uppercase text-xs tracking-widest">Saya Mengerti</button>
        </div>
    </div>

    <!-- Sidebar -->
    <aside class="w-20 lg:w-64 border-r border-[#30363D] flex flex-col items-center lg:items-stretch py-8 px-4 z-50 bg-[#0D1117]">
        <div class="mb-12 px-4">
            <h1 class="text-xl font-extrabold italic text-white tracking-tighter">FINEX<span class="text-[var(--gold)]">POS</span></h1>
        </div>
        <nav class="space-y-2 flex-1">
            <button class="w-full flex items-center gap-4 px-4 py-3 rounded-xl text-slate-500 hover:text-white transition-all">
                <i class="fa-solid fa-grid-2 text-lg"></i> <span class="hidden lg:block font-semibold text-sm uppercase tracking-wider">Dashboard</span>
            </button>
            <button class="w-full flex items-center gap-4 px-4 py-3 rounded-xl gold-gradient text-white shadow-lg">
                <i class="fa-solid fa-receipt text-lg"></i> <span class="hidden lg:block font-bold text-sm uppercase tracking-wider">Transaksi</span>
            </button>
        </nav>
        <div class="px-4 border-t border-[#30363D] pt-6">
            <div class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center text-xs font-bold text-slate-400">ADM</div>
        </div>
    </aside>

    <!-- Main Section -->
    <main class="flex-1 relative flex flex-col overflow-hidden">
        
        <!-- Top Bar -->
        <header class="h-20 flex items-center justify-between px-10 border-b border-[#30363D] bg-[#0A0C10]/80 backdrop-blur-md">
            <div>
                <h2 id="header-title" class="text-xs font-black uppercase tracking-[0.2em] text-slate-500">Pencarian Mitra</h2>
            </div>
            <div class="flex items-center gap-6">
                <div class="text-right">
                    <p id="clock" class="text-lg font-bold text-white tabular-nums">00:00:00</p>
                    <p class="text-[10px] text-slate-500 uppercase font-bold tracking-widest">WITA Timezone</p>
                </div>
            </div>
        </header>

        <div class="flex-1 flex flex-col items-center justify-center p-6 bg-[radial-gradient(circle_at_50%_50%,_#161B22_0%,_#0A0C10_100%)]">
            
            <!-- STEP 1: SEARCH -->
            <section id="step-search" class="step-content active w-full max-w-xl flex flex-col">
                <div class="text-center mb-10">
                    <h3 class="text-4xl font-bold mb-3 tracking-tight">Siapa yang <span class="text-[var(--gold)]">Melayani?</span></h3>
                    <p class="text-slate-500 font-medium">Ketik nama mitra atau scan untuk memulai</p>
                </div>
                
                <div class="relative">
                    <div class="absolute inset-y-0 left-6 flex items-center text-slate-500">
                        <i class="fa-solid fa-magnifying-glass text-xl"></i>
                    </div>
                    <input type="text" id="driver-search-input" autocomplete="off"
                        class="w-full h-20 pl-16 pr-6 rounded-3xl bg-[#161B22] border border-[#30363D] text-xl font-semibold focus:outline-none focus:border-[var(--gold)] transition-all placeholder:text-slate-600 shadow-2xl"
                        placeholder="Nama atau ID Mitra...">
                    
                    <div id="results-container" class="absolute top-full left-0 right-0 mt-3 bg-[#161B22] border border-[#30363D] rounded-2xl overflow-hidden hidden z-50 shadow-2xl">
                        <div id="results-list" class="max-h-[300px] overflow-y-auto"></div>
                    </div>
                </div>
            </section>

            <!-- STEP 2: VERIFICATION -->
            <section id="step-verify" class="step-content w-full max-w-md flex flex-col items-center">
                <div id="camera-wrapper" class="mb-8">
                    <div id="camera-placeholder" class="absolute inset-0 flex items-center justify-center bg-[#0D1117] z-10">
                        <i class="fa-solid fa-camera-rotate fa-spin text-slate-700 text-4xl"></i>
                    </div>
                    <video id="camera-view" autoplay muted playsinline></video>
                    <div class="scanning-ring"></div>
                </div>
                
                <div class="text-center space-y-2 mb-8">
                    <h4 id="verify-name" class="text-2xl font-black uppercase text-white tracking-tight">---</h4>
                    <div class="inline-flex items-center gap-2 px-3 py-1 bg-white/5 rounded-full border border-white/10 text-slate-400 text-xs font-mono">
                        <i class="fa-solid fa-fingerprint"></i> <span id="verify-id">---</span>
                    </div>
                </div>

                <div class="w-full bg-[#161B22] p-4 rounded-2xl border border-[#30363D] flex items-center justify-center gap-3 shadow-inner">
                    <div id="status-dot" class="w-2.5 h-2.5 rounded-full bg-slate-600"></div>
                    <span id="ai-status" class="text-xs font-bold uppercase tracking-widest text-slate-400">Menyiapkan Kamera...</span>
                </div>

                <button onclick="stopCameraAndReturn()" class="mt-8 text-slate-500 hover:text-white text-xs font-bold uppercase tracking-widest transition-all group">
                    <i class="fa-solid fa-arrow-left mr-2 group-hover:-translate-x-1 transition-transform"></i> Kembali ke Pencarian
                </button>
            </section>

            <!-- STEP 3: TRANSACTION FORM (BeautyBloom) -->
            <section id="step-form" class="step-content w-full max-w-4xl flex flex-col">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <div class="lg:col-span-4 space-y-4">
                        <div class="glass-panel p-6 rounded-[32px] text-center">
                            <div class="w-24 h-24 rounded-3xl overflow-hidden mx-auto mb-4 border-2 border-[var(--gold)]">
                                <img id="final-photo" src="" class="w-full h-full object-cover bg-[#0D1117]">
                            </div>
                            <h4 id="final-name" class="text-xl font-bold uppercase mb-1">---</h4>
                            <p id="final-id" class="text-xs font-mono text-slate-500">---</p>
                        </div>
                        
                        <div class="bg-emerald-500/10 border border-emerald-500/20 p-6 rounded-[32px] flex justify-between items-center">
                            <div>
                                <p class="text-[10px] font-black uppercase text-emerald-500/60 mb-1">Estimasi Komisi</p>
                                <p id="display-comm" class="text-2xl font-black text-emerald-400">Rp 0</p>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] font-black uppercase text-emerald-500/60 mb-1">Poin</p>
                                <p id="display-pax" class="text-2xl font-black text-white">0</p>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-8 glass-panel p-8 rounded-[32px] space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="text-[10px] font-black uppercase text-slate-500 ml-2 tracking-widest">Layanan</label>
                                <select id="service-select" class="w-full h-14 px-4 rounded-2xl input-elegant text-sm font-bold uppercase cursor-pointer">
                                    <option value="">-- Pilih Layanan --</option>
                                </select>
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black uppercase text-slate-500 ml-2 tracking-widest">Kategori Tamu</label>
                                <select id="guest-cat" class="w-full h-14 px-4 rounded-2xl input-elegant text-sm font-bold uppercase">
                                    <option value="Lokal">TAMU LOKAL</option>
                                    <option value="Asing">TAMU ASING</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="text-[10px] font-black uppercase text-slate-500 ml-2 tracking-widest">Jumlah Pax</label>
                                <div class="flex items-center gap-3">
                                    <button onclick="adjPax(-1)" class="w-14 h-14 rounded-2xl bg-[#0D1117] border border-[#30363D] hover:border-[var(--gold)] text-xl transition-all">-</button>
                                    <input type="number" id="pax-count" value="1" min="1" class="flex-1 h-14 rounded-2xl input-elegant text-center font-black text-xl">
                                    <button onclick="adjPax(1)" class="w-14 h-14 rounded-2xl bg-[#0D1117] border border-[#30363D] hover:border-[var(--gold)] text-xl transition-all">+</button>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black uppercase text-slate-500 ml-2 tracking-widest">Kamar / Meja</label>
                                <input type="text" id="room-no" placeholder="Contoh: 102" class="w-full h-14 px-6 rounded-2xl input-elegant font-bold">
                            </div>
                        </div>

                        <div class="pt-4 flex gap-4">
                            <button onclick="stopCameraAndReturn()" class="h-16 px-8 rounded-2xl bg-slate-800 text-slate-300 font-bold uppercase text-xs tracking-widest hover:bg-slate-700 transition-all">Batal</button>
                            <button id="submit-btn" onclick="processSubmit()" class="flex-1 h-16 rounded-2xl gold-gradient text-white font-black uppercase text-sm tracking-[0.1em] shadow-xl hover:scale-[1.01] active:scale-95 transition-all">
                                Simpan Transaksi <i class="fa-solid fa-paper-plane ml-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        const SUPABASE_URL = "https://qdxchvogaxiibzqvuupf.supabase.co"; 
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkeGNodm9nYXhpaWJ6cXZ1dXBmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxODE5NTIsImV4cCI6MjA4NTc1Nzk1Mn0.8U_zk81b6wFfdZdPRupk5KSk3g39nOPs8SpZVkWbqkc";
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentStep = 'step-search';
        let selectedMitra = null;
        let videoStream = null;
        let matcher = null;
        let analysisInterval = null;

        window.onload = () => {
            initAI();
            fetchServices();
            updateClock();
            setInterval(updateClock, 1000);
            checkSecurity();
        };

        function checkSecurity() {
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                showModal("Kamera hanya dapat diaktifkan pada koneksi aman (HTTPS). Pastikan URL diawali dengan https://");
            }
        }

        function showModal(msg) {
            document.getElementById('modal-msg').innerText = msg;
            document.getElementById('custom-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('custom-modal').style.display = 'none';
        }

        async function initAI() {
            const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
            } catch (e) {
                console.error("AI Models failed", e);
            }
        }

        async function fetchServices() {
            const { data } = await sb.from('services').select('*').order('name');
            const sel = document.getElementById('service-select');
            data?.forEach(s => {
                const opt = new Option(s.name.toUpperCase(), s.id);
                opt.dataset.comm = s.commission;
                opt.dataset.price = s.price;
                opt.dataset.name = s.name;
                sel.add(opt);
            });
        }

        function changeStep(stepId) {
            document.querySelectorAll('.step-content').forEach(s => s.classList.remove('active'));
            document.getElementById(stepId).classList.add('active');
            currentStep = stepId;
            document.getElementById('header-title').innerText = {
                'step-search': 'Pencarian Mitra',
                'step-verify': 'Verifikasi Identitas',
                'step-form': 'Detail Transaksi'
            }[stepId] || 'Finex POS';
        }

        // --- Search ---
        const searchInput = document.getElementById('driver-search-input');
        const resultsContainer = document.getElementById('results-container');
        const resultsList = document.getElementById('results-list');

        searchInput.oninput = async (e) => {
            const query = e.target.value.trim();
            if (query.length < 2) { resultsContainer.classList.add('hidden'); return; }
            const { data } = await sb.from('drivers').select('*').or(`name.ilike.%${query}%,driver_id.ilike.%${query}%`).limit(5);
            if (data?.length > 0) {
                resultsList.innerHTML = data.map(d => `
                    <div onclick="selectDriver('${d.driver_id}', '${d.name}', '${d.photo_url}')" 
                         class="p-4 flex items-center gap-4 hover:bg-white/5 cursor-pointer border-b border-white/5 transition-all">
                        <img src="${d.photo_url}" class="w-12 h-12 rounded-xl object-cover bg-slate-800">
                        <div class="flex-1">
                            <p class="font-bold text-white uppercase text-sm">${d.name}</p>
                            <p class="text-[10px] text-slate-500 font-mono">${d.driver_id}</p>
                        </div>
                    </div>
                `).join('');
                resultsContainer.classList.remove('hidden');
            } else {
                resultsList.innerHTML = `<div class="p-6 text-center text-slate-500 text-xs font-bold uppercase">Mitra Tidak Ditemukan</div>`;
                resultsContainer.classList.remove('hidden');
            }
        };

        function selectDriver(id, name, photo) {
            selectedMitra = { id, name, photo };
            resultsContainer.classList.add('hidden');
            searchInput.value = "";
            startVerification();
        }

        // --- Camera Logic ---
        async function startVerification() {
            changeStep('step-verify');
            document.getElementById('verify-name').innerText = selectedMitra.name;
            document.getElementById('verify-id').innerText = selectedMitra.id;
            document.getElementById('camera-placeholder').style.display = 'flex';
            document.getElementById('ai-status').innerText = "Membuka Kamera...";

            try {
                // Cek apakah browser mendukung kamera
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error("Browser ini tidak mendukung akses kamera.");
                }

                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user" } 
                });
                
                videoStream = stream;
                const video = document.getElementById('camera-view');
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    document.getElementById('camera-placeholder').style.display = 'none';
                    initFaceMatcher();
                };
            } catch (err) {
                console.error("Camera error:", err);
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    showModal("Akses kamera ditolak. Harap izinkan kamera melalui pengaturan browser (klik ikon gembok di sebelah URL).");
                } else {
                    showModal("Gagal mengakses kamera: " + err.message);
                }
                changeStep('step-search');
            }
        }

        async function initFaceMatcher() {
            const status = document.getElementById('ai-status');
            status.innerText = "Memuat Data Wajah...";
            try {
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.src = selectedMitra.photo;
                img.onload = async () => {
                    const detect = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                    if (detect) {
                        matcher = new faceapi.FaceMatcher(detect, 0.55);
                        status.innerText = "Scan Wajah Mitra...";
                        document.getElementById('status-dot').className = "w-2.5 h-2.5 rounded-full bg-blue-500 animate-pulse";
                        startAnalysisLoop();
                    } else {
                        status.innerText = "Foto Profil Tidak Valid";
                    }
                };
            } catch (e) { status.innerText = "Gagal Memvalidasi Wajah"; }
        }

        function startAnalysisLoop() {
            const video = document.getElementById('camera-view');
            analysisInterval = setInterval(async () => {
                if (currentStep !== 'step-verify') { clearInterval(analysisInterval); return; }
                const detect = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                if (detect) {
                    const match = matcher.findBestMatch(detect.descriptor);
                    if (match.distance < 0.5) {
                        document.getElementById('ai-status').innerText = "Terverifikasi!";
                        document.getElementById('status-dot').className = "w-2.5 h-2.5 rounded-full bg-emerald-500";
                        clearInterval(analysisInterval);
                        setTimeout(onVerified, 800);
                    } else {
                        document.getElementById('ai-status').innerText = "Wajah Tidak Cocok";
                    }
                }
            }, 500);
        }

        function onVerified() {
            stopCamera();
            document.getElementById('final-photo').src = selectedMitra.photo;
            document.getElementById('final-name').innerText = selectedMitra.name;
            document.getElementById('final-id').innerText = selectedMitra.id;
            changeStep('step-form');
        }

        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(t => t.stop());
                videoStream = null;
            }
            if (analysisInterval) clearInterval(analysisInterval);
        }

        function stopCameraAndReturn() {
            stopCamera();
            changeStep('step-search');
        }

        // --- Transaksi ---
        const svcSelect = document.getElementById('service-select');
        const paxInput = document.getElementById('pax-count');

        function adjPax(val) {
            paxInput.value = Math.max(1, (parseInt(paxInput.value) || 1) + val);
            updateSummary();
        }

        function updateSummary() {
            const opt = svcSelect.options[svcSelect.selectedIndex];
            const pax = parseInt(paxInput.value) || 0;
            if (opt.value) {
                const total = parseInt(opt.dataset.comm) * pax;
                document.getElementById('display-comm').innerText = `Rp ${total.toLocaleString('id-ID')}`;
                document.getElementById('display-pax').innerText = pax;
            }
        }

        svcSelect.onchange = updateSummary;
        paxInput.oninput = updateSummary;

        async function processSubmit() {
            const btn = document.getElementById('submit-btn');
            const opt = svcSelect.options[svcSelect.selectedIndex];
            if (!opt.value) { alert("Pilih layanan"); return; }
            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i> Menyimpan...`;

            const { error } = await sb.from('commissions').insert([{
                driver_id: selectedMitra.id,
                driver_name: selectedMitra.name,
                service_id: svcSelect.value,
                service_name: opt.dataset.name,
                guest_category: document.getElementById('guest-cat').value,
                massage_guests: parseInt(paxInput.value),
                commission_amount: parseInt(opt.dataset.comm) * parseInt(paxInput.value),
                points_earned: parseInt(paxInput.value),
                total_massage_value: parseInt(opt.dataset.price) * parseInt(paxInput.value),
                notes: document.getElementById('room-no').value,
                created_at: new Date().toISOString()
            }]);

            if (!error) {
                alert("âœ… Transaksi " + selectedMitra.name + " Berhasil Disimpan.");
                stopCameraAndReturn();
            } else {
                alert("Error: " + error.message);
            }
            btn.disabled = false;
            btn.innerHTML = `Simpan Transaksi <i class="fa-solid fa-paper-plane ml-2"></i>`;
        }

        function updateClock() {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString('id-ID', { hour12: false });
        }
    </script>
</body>
</html>
