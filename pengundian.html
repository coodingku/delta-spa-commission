<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finex Pos - Undian Poin Driver</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Urbanist', sans-serif; background-color: #020617; color: #f8fafc; overflow-x: hidden; }
        .card { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(212, 175, 55, 0.1); }
        .sidebar { background: #0f172a; border-right: 1px solid rgba(212, 175, 55, 0.1); }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 14px 20px; border-radius: 16px; color: #94a3b8; transition: 0.3s; margin-bottom: 8px; font-weight: 500; }
        .nav-link:hover { background: rgba(212, 175, 55, 0.05); color: #d4af37; }
        .nav-link.active { background: linear-gradient(135deg, #d4af37 0%, #a67c00 100%); color: white; }
        .gold-text { color: #d4af37; }
        .gold-button { background: linear-gradient(135deg, #d4af37 0%, #a67c00 100%); color: white; }
        
        .slot-machine {
            height: 120px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 4px solid #d4af37;
            background: #000;
            border-radius: 24px;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.2);
        }

        .winner-anim { animation: celebrate 0.5s ease infinite alternate; }
        @keyframes celebrate {
            from { transform: scale(1); filter: brightness(1); }
            to { transform: scale(1.05); filter: brightness(1.3); }
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen flex">

    <!-- Sidebar -->
    <aside class="w-72 shrink-0 flex flex-col sidebar hidden lg:flex h-screen sticky top-0">
        <div class="p-8 text-center">
            <h1 class="text-2xl font-black italic gold-text tracking-tighter">FINEX <span class="text-white">POS</span></h1>
            <p class="text-[10px] text-slate-500 font-bold tracking-[0.2em] mt-1 uppercase">BeautyBloom Management</p>
            <div class="h-px bg-gradient-to-r from-transparent via-[#d4af37]/50 to-transparent my-4"></div>
        </div>
        <nav class="flex-1 px-4">
            <a href="#" class="nav-link active"><i class="fa-solid fa-ticket w-5"></i> Undian Poin</a>
        </nav>
    </aside>

    <main class="flex-1 p-6 md:p-10">
        <div class="max-w-6xl mx-auto">
            <header class="mb-10 flex flex-col md:flex-row md:items-end justify-between gap-4">
                <div>
                    <h1 class="text-4xl font-black uppercase italic gold-text">Lucky <span class="text-white">Draw</span></h1>
                    <p class="text-slate-500 font-medium italic">Filter kandidat secara manual dan undi hadiah.</p>
                </div>
                
                <div class="bg-white/5 border border-white/10 px-6 py-3 rounded-2xl flex items-center gap-4">
                    <div class="text-right">
                        <p class="text-[10px] text-slate-500 font-bold uppercase">Target Poin Minimal</p>
                        <div class="flex items-center gap-2 justify-end">
                            <input type="number" id="min-points-input" value="10" oninput="fetchCandidates()" 
                            class="bg-transparent text-2xl font-black text-amber-500 w-20 text-right outline-none border-b-2 border-amber-500/30 focus:border-amber-500 transition-all">
                            <span class="text-xs font-bold text-slate-400">PTS</span>
                        </div>
                    </div>
                </div>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Panel Undian -->
                <div class="lg:col-span-8 space-y-6">
                    <div class="card p-10 rounded-[40px] text-center relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-[#d4af37] to-transparent"></div>
                        
                        <h2 class="text-slate-400 text-[10px] font-black uppercase tracking-[0.3em] mb-8">Pilih Pemenang Dari Kandidat</h2>
                        
                        <div class="slot-machine mb-8">
                            <div id="display-winner" class="text-4xl md:text-5xl font-black text-white uppercase italic tracking-tighter">
                                ACARA UNDIAN
                            </div>
                        </div>

                        <div id="winner-info" class="hidden mb-8 p-6 bg-white/5 rounded-3xl border border-white/10 animate-in fade-in zoom-in duration-500">
                            <p class="text-amber-500 text-[10px] uppercase font-black mb-1 tracking-widest">Pemenang Terpilih</p>
                            <h3 id="winner-name" class="text-4xl font-black gold-text mb-2 tracking-tighter uppercase italic">-</h3>
                            <p id="winner-points" class="text-white/60 font-medium text-xs">Total Poin: 0</p>
                        </div>

                        <div class="flex gap-4">
                            <button id="btn-draw" onclick="startDrawing()" class="flex-[2] py-6 gold-button rounded-2xl text-xl font-black uppercase tracking-widest hover:scale-[1.02] active:scale-95 transition-all shadow-2xl shadow-[#d4af37]/30 disabled:opacity-30">
                                <i class="fa-solid fa-rotate mr-2"></i> ACAK NAMA
                            </button>
                            <button id="btn-save-reset" onclick="confirmReset()" class="flex-1 py-6 bg-emerald-600 hover:bg-emerald-500 text-white rounded-2xl text-xs font-black uppercase tracking-widest transition-all disabled:opacity-30">
                                <i class="fa-solid fa-floppy-disk mr-2"></i> SIMPAN & RESET
                            </button>
                        </div>
                        
                        <p class="mt-6 text-[10px] text-slate-500 font-bold italic">Catatan: Klik 'Simpan & Reset' untuk mengenolkan poin semua driver yang ada di daftar kanan.</p>
                    </div>

                    <!-- History Log -->
                    <div class="card p-6 rounded-3xl">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xs font-black text-white uppercase tracking-widest">Aktivitas Terkini</h3>
                        </div>
                        <div id="draw-history" class="space-y-3">
                            <div class="text-center py-6 text-slate-700 text-[10px] uppercase font-bold italic tracking-widest">Belum ada riwayat undian hari ini</div>
                        </div>
                    </div>
                </div>

                <!-- Daftar Driver (Kandidat) -->
                <div class="lg:col-span-4 space-y-6">
                    <div class="card p-6 rounded-3xl border-[#d4af37]/20 flex flex-col h-full">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h3 class="text-xs font-black text-white uppercase tracking-widest">Kandidat Hadir</h3>
                                <p class="text-[9px] text-slate-500 font-bold uppercase mt-1">Berdasarkan Filter Poin</p>
                            </div>
                            <span id="candidate-count" class="bg-amber-500 text-black text-[10px] font-black px-2 py-1 rounded">0</span>
                        </div>
                        
                        <div id="candidate-list" class="space-y-2 overflow-y-auto max-h-[600px] pr-2">
                            <!-- JS Render -->
                        </div>
                        
                        <div id="loading-state" class="hidden text-center py-10">
                            <i class="fa-solid fa-circle-notch fa-spin text-amber-500 text-2xl"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Konfirmasi Reset -->
    <div id="reset-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-6">
        <div class="bg-[#0f172a] border border-white/10 p-8 rounded-[32px] max-w-sm w-full text-center shadow-2xl">
            <div class="w-20 h-20 bg-emerald-500/10 text-emerald-500 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fa-solid fa-triangle-exclamation text-3xl"></i>
            </div>
            <h3 class="text-xl font-black text-white mb-2 uppercase italic tracking-tighter">Konfirmasi Reset</h3>
            <p class="text-slate-400 text-xs leading-relaxed mb-8">Anda akan me-reset poin semua driver yang muncul di daftar kandidat saat ini menjadi <span class="text-white font-bold">0</span>. Tindakan ini tidak dapat dibatalkan.</p>
            <div class="flex gap-4">
                <button onclick="closeModal()" class="flex-1 py-4 bg-white/5 hover:bg-white/10 text-slate-400 rounded-2xl text-[10px] font-black uppercase transition-all">Batal</button>
                <button onclick="executeReset()" class="flex-1 py-4 bg-emerald-600 hover:bg-emerald-500 text-white rounded-2xl text-[10px] font-black uppercase transition-all">Ya, Reset Sekarang</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://qdxchvogaxiibzqvuupf.supabase.co"; 
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkeGNodm9nYXhpaWJ6cXZ1dXBmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxODE5NTIsImV4cCI6MjA4NTc1Nzk1Mn0.8U_zk81b6wFfdZdPRupk5KSk3g39nOPs8SpZVkWbqkc";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let candidates = [];

        async function init() {
            await fetchCandidates();
        }

        async function fetchCandidates() {
            const listEl = document.getElementById('candidate-list');
            const loader = document.getElementById('loading-state');
            const minPoints = parseInt(document.getElementById('min-points-input').value) || 0;

            loader.classList.remove('hidden');
            listEl.classList.add('opacity-20');

            try {
                const { data, error } = await supabaseClient
                    .from('commissions')
                    .select('driver_name, points_earned, is_redeemed');

                if (error) throw error;

                // Hanya ambil yang is_redeemed-nya belum True
                const activeData = data.filter(item => !item.is_redeemed);

                // Agregasi poin per driver
                const summary = activeData.reduce((acc, curr) => {
                    const name = curr.driver_name || 'Driver Tanpa Nama';
                    acc[name] = (acc[name] || 0) + (parseFloat(curr.points_earned) || 0);
                    return acc;
                }, {});

                // Filter berdasarkan angka manual yang diketik user
                candidates = Object.keys(summary)
                    .map(name => ({ name, points: summary[name] }))
                    .filter(d => d.points >= minPoints)
                    .sort((a, b) => b.points - a.points);

                renderCandidates();
            } catch (err) {
                console.error(err);
            } finally {
                loader.classList.add('hidden');
                listEl.classList.remove('opacity-20');
            }
        }

        function renderCandidates() {
            const listEl = document.getElementById('candidate-list');
            document.getElementById('candidate-count').innerText = candidates.length;
            const btnDraw = document.getElementById('btn-draw');
            const btnSave = document.getElementById('btn-save-reset');

            if (candidates.length === 0) {
                listEl.innerHTML = `
                    <div class="text-center py-12">
                        <p class="text-[10px] text-slate-700 font-black uppercase italic tracking-widest">Tidak ada driver mencapai target poin</p>
                    </div>`;
                btnDraw.disabled = true;
                btnSave.disabled = true;
                return;
            }

            btnDraw.disabled = false;
            btnSave.disabled = false;
            listEl.innerHTML = candidates.map(c => `
                <div class="flex items-center justify-between p-4 bg-white/5 rounded-2xl border border-white/5 hover:border-amber-500/20 transition-all">
                    <div>
                        <p class="text-[11px] font-black text-slate-200 uppercase">${c.name}</p>
                        <p class="text-[8px] text-emerald-500 font-bold tracking-widest">QUALIFIED</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-black text-white">${c.points}</p>
                        <p class="text-[8px] text-slate-500 uppercase font-black">Points</p>
                    </div>
                </div>
            `).join('');
        }

        function startDrawing() {
            const btn = document.getElementById('btn-draw');
            const display = document.getElementById('display-winner');
            const info = document.getElementById('winner-info');
            
            btn.disabled = true;
            info.classList.add('hidden');
            display.classList.remove('winner-anim', 'gold-text');

            let counter = 0;
            const duration = 3000;
            const interval = setInterval(() => {
                const randomName = candidates[Math.floor(Math.random() * candidates.length)].name;
                display.innerText = randomName;
                counter += 100;
                
                if (counter >= duration) {
                    clearInterval(interval);
                    finalizeWinner();
                    btn.disabled = false;
                }
            }, 100);
        }

        function finalizeWinner() {
            // Peluang berdasarkan jumlah poin
            const pool = [];
            candidates.forEach(c => {
                for(let i=0; i<Math.floor(c.points); i++) pool.push(c);
            });

            const winner = pool[Math.floor(Math.random() * pool.length)];
            
            const display = document.getElementById('display-winner');
            display.innerText = winner.name;
            display.classList.add('winner-anim', 'gold-text');
            
            document.getElementById('winner-name').innerText = winner.name;
            document.getElementById('winner-points').innerText = `Total Akumulasi Poin: ${winner.points}`;
            document.getElementById('winner-info').classList.remove('hidden');

            confetti({
                particleCount: 200,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#d4af37', '#ffffff', '#fbbf24']
            });

            // Tambahkan ke riwayat tampilan sementara
            const historyEl = document.getElementById('draw-history');
            if (historyEl.innerHTML.includes('Belum ada')) historyEl.innerHTML = '';
            
            const log = `
                <div class="flex items-center justify-between p-4 bg-amber-500/5 border border-amber-500/10 rounded-2xl animate-in slide-in-from-right">
                    <p class="text-[11px] font-black text-white uppercase italic">${winner.name}</p>
                    <span class="text-[8px] px-2 py-1 bg-amber-500/20 text-amber-500 rounded-lg font-black uppercase italic">Menang Undian</span>
                </div>
            `;
            historyEl.innerHTML = log + historyEl.innerHTML;
        }

        function confirmReset() {
            document.getElementById('reset-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('reset-modal').classList.add('hidden');
        }

        async function executeReset() {
            closeModal();
            const btnSave = document.getElementById('btn-save-reset');
            btnSave.disabled = true;
            btnSave.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> MEMPROSES...';

            try {
                // Ambil daftar nama driver yang ada di kandidat saat ini
                const namesToReset = candidates.map(c => c.name);

                // Update database: Tandai is_redeemed = true untuk nama-nama ini
                const { error } = await supabaseClient
                    .from('commissions')
                    .update({ is_redeemed: true })
                    .in('driver_name', namesToReset)
                    .or('is_redeemed.eq.false,is_redeemed.is.null');

                if (error) throw error;

                // Refresh data (kandidat akan kosong karena poin sudah di-reset)
                await fetchCandidates();
                
                // Beri notifikasi visual sederhana
                document.getElementById('display-winner').innerText = "DATA DI-RESET!";
                setTimeout(() => {
                    document.getElementById('display-winner').innerText = "SIAP DIUNDI";
                    document.getElementById('winner-info').classList.add('hidden');
                }, 3000);

            } catch (err) {
                console.error("Reset Error:", err);
                alert("Gagal meriset data. Periksa koneksi internet Anda.");
            } finally {
                btnSave.disabled = false;
                btnSave.innerHTML = '<i class="fa-solid fa-floppy-disk mr-2"></i> SIMPAN & RESET';
            }
        }

        window.onload = init;
    </script>
</body>
</html>
