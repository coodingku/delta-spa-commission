<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finex Pos - Professional Lucky Draw</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #030712; color: #f3f4f6; }
        .glass { background: rgba(17, 24, 39, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .gold-gradient { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .gold-text { background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .slot-box {
            height: 100px;
            overflow: hidden;
            border: 2px solid #f59e0b;
            background: #000;
            border-radius: 20px;
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.15);
        }

        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(245, 158, 11, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }
        .winner-active { animation: pulse-gold 2s infinite; }
    </style>
</head>
<body class="min-h-screen">

    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
            <div class="text-center md:text-left">
                <h1 class="text-3xl font-extrabold italic tracking-tighter uppercase">Finex <span class="text-amber-500">Pos</span></h1>
                <p class="text-slate-500 text-sm font-medium tracking-widest uppercase">BeautyBloom Driver Rewards</p>
            </div>
            
            <div class="flex flex-wrap justify-center gap-4">
                <div class="glass px-6 py-3 rounded-2xl flex flex-col items-center">
                    <span class="text-[10px] text-slate-500 font-bold uppercase">Minimal Poin</span>
                    <input type="number" id="min-points-input" value="10" onchange="fetchData()" class="bg-transparent text-amber-500 text-xl font-bold w-16 text-center focus:outline-none">
                </div>
                <div class="glass px-6 py-3 rounded-2xl flex flex-col items-center">
                    <span class="text-[10px] text-slate-500 font-bold uppercase">Total Kandidat</span>
                    <span id="stat-candidates" class="text-xl font-bold text-white">0</span>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Sidebar: Kandidat & Hadiah -->
            <div class="lg:col-span-4 space-y-6">
                <!-- Input Hadiah -->
                <div class="glass p-6 rounded-[32px]">
                    <h3 class="text-xs font-black uppercase tracking-widest mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-gift text-amber-500"></i> Daftar Hadiah
                    </h3>
                    <textarea id="prize-list" class="w-full bg-black/40 border border-white/10 rounded-xl p-3 text-sm text-slate-300 focus:border-amber-500 transition-all outline-none" rows="3" placeholder="Masukkan hadiah (pisahkan dengan koma)...">Sepeda Motor, Uang Tunai Rp 1 Juta, Smartphone, Helm Eksklusif</textarea>
                </div>

                <!-- Daftar Kandidat -->
                <div class="glass p-6 rounded-[32px] overflow-hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xs font-black uppercase tracking-widest">Kandidat Valid</h3>
                        <button onclick="fetchData()" class="text-amber-500 text-xs font-bold hover:underline">Refresh</button>
                    </div>
                    <div id="list-container" class="space-y-2 max-h-[400px] overflow-y-auto pr-2">
                        <!-- Content via JS -->
                    </div>
                </div>
            </div>

            <!-- Main Draw Area -->
            <div class="lg:col-span-8 space-y-6">
                <div class="glass p-10 rounded-[40px] relative overflow-hidden text-center">
                    <div class="absolute top-0 left-0 w-full h-1.5 gold-gradient opacity-50"></div>
                    
                    <p class="text-slate-500 text-[10px] font-black uppercase tracking-[0.4em] mb-10">Undian Keberuntungan Driver</p>
                    
                    <!-- Slot Machine Display -->
                    <div class="slot-box flex flex-col items-center justify-center mb-10">
                        <div id="draw-display" class="text-4xl md:text-5xl font-black italic uppercase tracking-tighter text-white">
                            READY TO ROLL
                        </div>
                        <div id="prize-display" class="hidden text-amber-500 font-bold text-sm mt-2 uppercase tracking-widest"></div>
                    </div>

                    <!-- Result Panel -->
                    <div id="result-panel" class="hidden mb-10 p-8 bg-amber-500/10 border border-amber-500/20 rounded-[32px] animate-in zoom-in duration-500">
                        <div class="flex justify-center mb-4">
                            <span class="bg-amber-500 text-black text-[10px] font-black px-4 py-1 rounded-full uppercase">Selamat Kepada</span>
                        </div>
                        <h2 id="winner-name" class="text-5xl font-black gold-text italic uppercase mb-2">DRIVER NAME</h2>
                        <div class="flex items-center justify-center gap-3">
                            <span id="winner-prize" class="text-white font-bold text-lg">Hadiah Utama</span>
                        </div>
                        <p id="winner-meta" class="text-slate-500 text-xs mt-4 font-medium uppercase"></p>
                    </div>

                    <button id="btn-main" onclick="startDraw()" class="w-full py-6 gold-gradient text-black font-black text-xl rounded-2xl shadow-xl shadow-amber-500/20 hover:scale-[1.01] active:scale-95 transition-all disabled:opacity-20">
                        MULAI PENGUNDIAN
                    </button>

                    <div class="mt-8 flex justify-center gap-8">
                        <div class="text-center">
                            <p class="text-slate-600 text-[9px] font-bold uppercase">System Security</p>
                            <p class="text-emerald-500 text-[10px] font-black italic">ENCRYPTED</p>
                        </div>
                        <div class="text-center">
                            <p class="text-slate-600 text-[9px] font-bold uppercase">Reset Mode</p>
                            <p class="text-amber-500 text-[10px] font-black italic">AUTO-CLEAR</p>
                        </div>
                    </div>
                </div>

                <!-- History -->
                <div class="glass p-6 rounded-[32px]">
                    <h3 class="text-xs font-black uppercase tracking-widest mb-4">Riwayat Pemenang Hari Ini</h3>
                    <div id="history-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-full py-10 text-center text-slate-700 text-xs font-bold uppercase italic tracking-widest">Belum Ada Riwayat</div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://qdxchvogaxiibzqvuupf.supabase.co"; 
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkeGNodm9nYXhpaWJ6cXZ1dXBmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxODE5NTIsImV4cCI6MjA4NTc1Nzk1Mn0.8U_zk81b6wFfdZdPRupk5KSk3g39nOPs8SpZVkWbqkc";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let driverData = [];
        let isSpinning = false;

        async function init() {
            await fetchData();
        }

        async function fetchData() {
            const minPoints = parseInt(document.getElementById('min-points-input').value) || 0;
            const listContainer = document.getElementById('list-container');
            listContainer.innerHTML = '<div class="text-center py-10 opacity-20"><i class="fa-solid fa-circle-notch fa-spin text-2xl"></i></div>';

            try {
                // Ambil data yang belum diundi
                const { data, error } = await supabaseClient
                    .from('commissions')
                    .select('driver_name, points_earned, is_redeemed')
                    .or('is_redeemed.eq.false,is_redeemed.is.null');

                if (error) throw error;

                // Agregasi poin per driver
                const summary = data.reduce((acc, curr) => {
                    const name = curr.driver_name || 'Driver Anonim';
                    acc[name] = (acc[name] || 0) + (parseFloat(curr.points_earned) || 0);
                    return acc;
                }, {});

                // Filter berdasarkan minimal poin input user
                driverData = Object.keys(summary)
                    .map(name => ({ name, points: summary[name] }))
                    .filter(d => d.points >= minPoints)
                    .sort((a, b) => b.points - a.points);

                renderList();
                document.getElementById('stat-candidates').innerText = driverData.length;
                document.getElementById('btn-main').disabled = driverData.length === 0;
            } catch (err) {
                console.error(err);
                listContainer.innerHTML = '<p class="text-red-500 text-xs text-center p-4">Gagal memuat data database.</p>';
            }
        }

        function renderList() {
            const listContainer = document.getElementById('list-container');
            if (driverData.length === 0) {
                listContainer.innerHTML = '<p class="text-slate-600 text-center py-10 text-[10px] font-bold uppercase italic">Tidak ada driver mencapai target</p>';
                return;
            }

            listContainer.innerHTML = driverData.map(d => `
                <div class="flex items-center justify-between p-4 bg-white/5 rounded-2xl border border-white/5 hover:border-amber-500/30 transition-all">
                    <span class="text-xs font-bold uppercase text-slate-300">${d.name}</span>
                    <div class="text-right">
                        <span class="text-sm font-black text-amber-500">${d.points}</span>
                        <span class="text-[8px] block text-slate-600 font-bold uppercase">Poin</span>
                    </div>
                </div>
            `).join('');
        }

        function startDraw() {
            if (isSpinning || driverData.length === 0) return;
            
            const prizes = document.getElementById('prize-list').value.split(',').map(p => p.trim()).filter(p => p);
            if (prizes.length === 0) {
                alert("Masukkan minimal satu hadiah!");
                return;
            }

            isSpinning = true;
            const btn = document.getElementById('btn-main');
            const display = document.getElementById('draw-display');
            const resPanel = document.getElementById('result-panel');
            
            btn.disabled = true;
            resPanel.classList.add('hidden');
            display.classList.remove('gold-text');

            let timer = 0;
            const duration = 3000;
            const spinInterval = setInterval(() => {
                const randomDriver = driverData[Math.floor(Math.random() * driverData.length)].name;
                display.innerText = randomDriver;
                timer += 50;
                
                if (timer >= duration) {
                    clearInterval(spinInterval);
                    finishDraw(prizes);
                }
            }, 50);
        }

        async function finishDraw(prizes) {
            // Peluang berbasis poin (Weighted Random)
            let weightedPool = [];
            driverData.forEach(d => {
                // Tiap 1 poin = 1 tiket di kolam undian
                for(let i=0; i < Math.floor(d.points); i++) weightedPool.push(d);
            });

            const winner = weightedPool[Math.floor(Math.random() * weightedPool.length)];
            const randomPrize = prizes[Math.floor(Math.random() * prizes.length)];

            // Update UI
            const display = document.getElementById('draw-display');
            display.innerText = winner.name;
            display.classList.add('gold-text');
            
            document.getElementById('winner-name').innerText = winner.name;
            document.getElementById('winner-prize').innerText = randomPrize;
            document.getElementById('winner-meta').innerText = `Menang dengan akumulasi ${winner.points} poin`;
            document.getElementById('result-panel').classList.remove('hidden');

            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#f59e0b', '#ffffff']
            });

            await saveAndReset(winner, randomPrize);
            
            isSpinning = false;
            document.getElementById('btn-main').disabled = false;
        }

        async function saveAndReset(winner, prize) {
            // Update History di UI
            const historyList = document.getElementById('history-list');
            if (historyList.innerText.includes('Belum Ada')) historyList.innerHTML = '';
            
            const log = `
                <div class="p-4 bg-white/5 rounded-2xl border border-amber-500/20 flex justify-between items-center">
                    <div>
                        <p class="text-xs font-black uppercase text-white">${winner.name}</p>
                        <p class="text-[9px] font-bold text-amber-500 uppercase">${prize}</p>
                    </div>
                    <span class="text-[8px] text-slate-600 font-bold">${new Date().toLocaleTimeString()}</span>
                </div>
            `;
            historyList.innerHTML = log + historyList.innerHTML;

            // Reset Poin di Database (Tandai sudah diundi)
            try {
                await supabaseClient
                    .from('commissions')
                    .update({ is_redeemed: true })
                    .or('is_redeemed.eq.false,is_redeemed.is.null');
                
                // Refresh data setelah beberapa detik
                setTimeout(fetchData, 2000);
            } catch (err) {
                console.error("Database reset error:", err);
            }
        }

        window.onload = init;
    </script>
</body>
</html>
