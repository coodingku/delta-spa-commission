<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delta Spa - Laporan Komisi & Frekuensi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Library untuk Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Urbanist', sans-serif; background-color: #020617; color: #f8fafc; }
        .card { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(212, 175, 55, 0.1); }
        .sidebar { background: #0f172a; border-right: 1px solid rgba(212, 175, 55, 0.1); }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 14px 20px; border-radius: 16px; color: #94a3b8; transition: 0.3s; margin-bottom: 8px; font-weight: 500; }
        .nav-link:hover { background: rgba(212, 175, 55, 0.05); color: #d4af37; }
        .nav-link.active { background: linear-gradient(135deg, #d4af37 0%, #a67c00 100%); color: white; }
        .gold-text { color: #d4af37; }
        .gold-button { background: linear-gradient(135deg, #d4af37 0%, #a67c00 100%); color: white; }
        .input-dark { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(212, 175, 55, 0.2); color: white; }
        .input-dark:focus { border-color: #d4af37; outline: none; ring: 1px solid #d4af37; }
        
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; color: black !important; }
            .card { border: 1px solid #ddd !important; background: transparent !important; }
            .gold-text { color: black !important; font-weight: bold; }
        }
    </style>
</head>
<body class="min-h-screen flex">

    <!-- Sidebar -->
    <aside class="w-72 shrink-0 flex flex-col sidebar hidden lg:flex no-print h-screen sticky top-0">
        <div class="p-8 text-center">
            <h1 class="text-2xl font-black italic gold-text tracking-tighter">DELTA <span class="text-white">SPA</span></h1>
            <div class="h-px bg-gradient-to-r from-transparent via-[#d4af37]/50 to-transparent my-4"></div>
        </div>
        <nav class="flex-1 px-4">
            <a href="#" class="nav-link"><i class="fa-solid fa-chart-line w-5"></i> Dashboard</a>
            <a href="#" class="nav-link"><i class="fa-solid fa-plus-circle w-5"></i> Input Transaksi</a>
            <a href="#" class="nav-link active"><i class="fa-solid fa-file-invoice-dollar w-5"></i> Laporan Komisi</a>
        </nav>
    </aside>

    <main class="flex-1 p-6 md:p-10">
        <div class="max-w-7xl mx-auto">
            
            <header class="mb-10 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-3xl font-black uppercase italic gold-text">Data <span class="text-white">Komisi Driver</span></h1>
                    <p class="text-slate-500 text-sm italic">Delta Spa Management System</p>
                </div>
                <div class="flex flex-wrap gap-2 no-print">
                    <button onclick="exportToExcel()" class="px-4 py-2 bg-emerald-600/20 text-emerald-400 border border-emerald-600/30 rounded-lg text-xs font-bold hover:bg-emerald-600 hover:text-white transition-all flex items-center gap-2">
                        <i class="fa-solid fa-file-excel"></i> EXCEL
                    </button>
                    <button onclick="exportToPDF()" class="px-4 py-2 bg-rose-600/20 text-rose-400 border border-rose-600/30 rounded-lg text-xs font-bold hover:bg-rose-600 hover:text-white transition-all flex items-center gap-2">
                        <i class="fa-solid fa-file-pdf"></i> PDF
                    </button>
                    <button onclick="window.print()" class="px-4 py-2 bg-slate-800 text-white border border-slate-700 rounded-lg text-xs font-bold hover:bg-slate-700 transition-all flex items-center gap-2">
                        <i class="fa-solid fa-print"></i> CETAK
                    </button>
                </div>
            </header>

            <!-- Filter Section -->
            <div class="card p-6 rounded-2xl mb-8 no-print border-b-2 border-b-[#d4af37]/30">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="flex flex-col gap-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Dari Tanggal</label>
                        <input type="date" id="filter-start" class="input-dark px-4 py-2.5 rounded-xl text-sm">
                    </div>
                    <div class="flex flex-col gap-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Sampai Tanggal</label>
                        <input type="date" id="filter-end" class="input-dark px-4 py-2.5 rounded-xl text-sm">
                    </div>
                    <div class="flex flex-col gap-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Cari Nama Driver</label>
                        <div class="relative">
                            <i class="fa-solid fa-search absolute left-4 top-3 text-slate-600 text-xs"></i>
                            <input type="text" id="filter-driver" placeholder="Nama Driver..." class="input-dark pl-10 pr-4 py-2.5 rounded-xl text-sm w-full uppercase italic font-bold">
                        </div>
                    </div>
                    <div class="flex items-end">
                        <button onclick="applyFilters()" class="w-full py-2.5 gold-button rounded-xl text-xs font-black uppercase tracking-widest hover:brightness-110 transition-all shadow-lg shadow-[#d4af37]/20">
                            Terapkan Filter
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="card p-5 rounded-2xl">
                    <p class="text-[10px] font-bold text-slate-500 uppercase mb-1 tracking-tighter">Total Transaksi</p>
                    <h3 id="stat-count" class="text-xl font-black text-white italic">0</h3>
                </div>
                <div class="card p-5 rounded-2xl">
                    <p class="text-[10px] font-bold text-slate-500 uppercase mb-1 tracking-tighter">Total Pax</p>
                    <h3 id="stat-pax" class="text-xl font-black text-white italic">0</h3>
                </div>
                <div class="card p-5 rounded-2xl border-r-4 border-r-[#d4af37]">
                    <p class="text-[10px] font-bold gold-text uppercase mb-1 tracking-tighter text-right">Total Komisi</p>
                    <h3 id="stat-commission" class="text-xl font-black gold-text italic text-right">Rp 0</h3>
                </div>
                <div class="card p-5 rounded-2xl">
                    <p class="text-[10px] font-bold text-slate-500 uppercase mb-1 tracking-tighter">Rata-rata/Pax</p>
                    <h3 id="stat-avg" class="text-xl font-black text-white italic">Rp 0</h3>
                </div>
            </div>

            <!-- Table -->
            <div class="card rounded-3xl overflow-hidden shadow-2xl">
                <div class="overflow-x-auto">
                    <table id="report-table" class="w-full text-sm">
                        <thead>
                            <tr class="bg-slate-900/90 text-slate-500 text-[10px] uppercase tracking-widest font-black">
                                <th class="px-6 py-5 text-left">Tanggal</th>
                                <th class="px-6 py-5 text-left">Driver</th>
                                <th class="px-6 py-5 text-left">Nama Tamu</th>
                                <th class="px-6 py-5 text-center">Pax</th>
                                <th class="px-6 py-5 text-right">Nilai Layanan</th>
                                <th class="px-6 py-5 text-right gold-text">Komisi</th>
                            </tr>
                        </thead>
                        <tbody id="report-body" class="text-slate-300 divide-y divide-slate-800/50">
                            <!-- Data injected here -->
                        </tbody>
                        <tfoot class="bg-slate-950/80 border-t-2 border-slate-800">
                            <tr class="font-black text-white italic">
                                <td colspan="3" class="px-6 py-6 text-right uppercase text-[10px] text-slate-500">Total Keseluruhan</td>
                                <td id="foot-pax" class="px-6 py-6 text-center text-lg">-</td>
                                <td id="foot-value" class="px-6 py-6 text-right text-lg">-</td>
                                <td id="foot-comm" class="px-6 py-6 text-right gold-text text-xl">-</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        const SUPABASE_URL = "https://qdxchvogaxiibzqvuupf.supabase.co"; 
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkeGNodm9nYXhpaWJ6cXZ1dXBmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxODE5NTIsImV4cCI6MjA4NTc1Nzk1Mn0.8U_zk81b6wFfdZdPRupk5KSk3g39nOPs8SpZVkWbqkc";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let masterData = [];

        async function init() {
            // Set default date range (this month)
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
            const lastDay = today.toISOString().split('T')[0];
            document.getElementById('filter-start').value = firstDay;
            document.getElementById('filter-end').value = lastDay;
            
            await fetchLaporan();
        }

        async function fetchLaporan() {
            try {
                const { data, error } = await supabaseClient
                    .from('commissions')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                masterData = data || [];
                applyFilters();
            } catch (err) {
                console.error(err);
                document.getElementById('report-body').innerHTML = `<tr><td colspan="6" class="p-10 text-center text-red-400 font-bold uppercase italic">Gagal memuat data dari server Delta Spa</td></tr>`;
            }
        }

        function applyFilters() {
            const start = document.getElementById('filter-start').value;
            const end = document.getElementById('filter-end').value;
            const driver = document.getElementById('filter-driver').value.toLowerCase();

            const filtered = masterData.filter(item => {
                const itemDate = item.created_at.split('T')[0];
                const dateMatch = (!start || itemDate >= start) && (!end || itemDate <= end);
                const driverMatch = !driver || (item.driver_name && item.driver_name.toLowerCase().includes(driver));
                return dateMatch && driverMatch;
            });

            renderTable(filtered);
        }

        function renderTable(data) {
            const body = document.getElementById('report-body');
            if (data.length === 0) {
                body.innerHTML = `<tr><td colspan="6" class="p-20 text-center text-slate-600 font-black uppercase italic tracking-widest">Data Tidak Ditemukan</td></tr>`;
                updateStats(0, 0, 0, 0);
                return;
            }

            let tPax = 0, tVal = 0, tComm = 0;

            body.innerHTML = data.map(item => {
                const pax = parseInt(item.massage_guests) || 0;
                const val = parseInt(item.total_massage_value) || 0;
                const comm = parseInt(item.commission_amount) || 0;

                tPax += pax;
                tVal += val;
                tComm += comm;

                const tgl = new Date(item.created_at).toLocaleDateString('id-ID', { day:'2-digit', month:'short', year:'numeric' });

                return `
                    <tr class="hover:bg-white/5 transition-all">
                        <td class="px-6 py-4 text-slate-500 font-medium">${tgl}</td>
                        <td class="px-6 py-4 font-black text-white uppercase italic tracking-tighter">${item.driver_name || '-'}</td>
                        <td class="px-6 py-4">
                            <div class="font-bold text-slate-200">${item.customer_name || 'Anonymous'}</div>
                            <div class="text-[10px] text-slate-500 uppercase">${item.service_name || '-'}</div>
                        </td>
                        <td class="px-6 py-4 text-center font-bold text-white">${pax}</td>
                        <td class="px-6 py-4 text-right">Rp ${val.toLocaleString('id-ID')}</td>
                        <td class="px-6 py-4 text-right font-black gold-text italic text-lg">Rp ${comm.toLocaleString('id-ID')}</td>
                    </tr>
                `;
            }).join('');

            updateStats(data.length, tPax, tVal, tComm);
        }

        function updateStats(count, pax, val, comm) {
            document.getElementById('stat-count').innerText = count;
            document.getElementById('stat-pax').innerText = pax;
            document.getElementById('stat-commission').innerText = `Rp ${comm.toLocaleString('id-ID')}`;
            document.getElementById('stat-avg').innerText = `Rp ${(pax > 0 ? Math.round(comm/pax) : 0).toLocaleString('id-ID')}`;

            document.getElementById('foot-pax').innerText = pax;
            document.getElementById('foot-value').innerText = `Rp ${val.toLocaleString('id-ID')}`;
            document.getElementById('foot-comm').innerText = `Rp ${comm.toLocaleString('id-ID')}`;
        }

        function exportToExcel() {
            const table = document.getElementById("report-table");
            const wb = XLSX.utils.table_to_book(table, { sheet: "Laporan Delta Spa" });
            XLSX.writeFile(wb, `Delta_Spa_Report_${new Date().getTime()}.xlsx`);
        }

        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            doc.setFontSize(20);
            doc.setTextColor(166, 124, 0); // Gold
            doc.text("DELTA SPA - LAPORAN KOMISI DRIVER", 14, 20);
            
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`Dicetak pada: ${new Date().toLocaleString('id-ID')}`, 14, 28);

            doc.autoTable({
                html: '#report-table',
                startY: 35,
                theme: 'striped',
                headStyles: { fillStyle: 'dark', fillColor: [15, 23, 42], textColor: [212, 175, 55] },
                alternateRowStyles: { fillColor: [245, 245, 245] },
                styles: { fontSize: 8, font: 'helvetica' }
            });

            doc.save(`Delta_Spa_Report_${new Date().getTime()}.pdf`);
        }

        window.onload = init;
    </script>
</body>
</html>
