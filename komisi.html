<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delta Spa - Manajemen Komisi Driver</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Urbanist', sans-serif; background-color: #020617; color: #f8fafc; }
        .gold-gradient { background: linear-gradient(135deg, #d4af37 0%, #a67c00 100%); }
        .card { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(212, 175, 55, 0.1); }
        .sidebar { background: #0f172a; border-right: 1px solid rgba(212, 175, 55, 0.1); }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 14px 20px; border-radius: 16px; color: #64748b; transition: all 0.3s; margin-bottom: 4px; cursor: pointer; }
        .nav-link:hover { color: #d4af37; background: rgba(212, 175, 55, 0.05); }
        .nav-link.active { background: #d4af37; color: white; box-shadow: 0 10px 15px -3px rgba(212, 175, 55, 0.3); }
        
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 80mm; padding: 5mm; color: black !important; background: white !important; }
        }
    </style>
</head>
<body class="min-h-screen flex">
    <!-- Area Print Struk -->
    <div id="print-area" class="hidden text-black font-mono text-[10pt]">
        <div class="text-center border-b border-black pb-2 mb-2">
            <h2 class="font-bold uppercase">Delta Spa</h2>
            <p class="text-[8pt]">Bukti Komisi Driver</p>
        </div>
        <div class="space-y-1">
            <p>Tgl: <span id="p-date"></span></p>
            <p>Driver: <span id="p-name"></span></p>
            <p>Layanan: <span id="p-service"></span></p>
            <div class="border-y border-black py-1 my-1">
                <div class="flex justify-between">
                    <span>Tamu x <span id="p-guests">0</span></span>
                    <span id="p-rate">@ Rp 0</span>
                </div>
                <div class="flex justify-between font-bold border-t border-dashed border-black mt-1 pt-1">
                    <span>TOTAL KOMISI</span>
                    <span id="p-total">Rp 0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <aside class="w-72 shrink-0 flex flex-col sidebar hidden md:flex p-6">
        <div class="mb-10 px-2">
            <h1 class="text-2xl font-extrabold tracking-tighter text-white uppercase italic">Delta <span class="text-[#d4af37]">Spa</span></h1>
            <p class="text-[9px] text-slate-500 uppercase tracking-[0.2em] font-bold">Premium System</p>
        </div>
        
        <nav class="flex-1 space-y-1">
            <p class="text-[10px] font-bold text-slate-600 uppercase tracking-widest px-4 mb-2">Operasional</p>
            <div onclick="switchTab('transaksi')" id="menu-transaksi" class="nav-link active">
                <i class="fa-solid fa-plus-circle w-5"></i>
                <span class="font-semibold">Input Transaksi</span>
            </div>
            <div onclick="switchTab('history')" id="menu-history" class="nav-link">
                <i class="fa-solid fa-clock-rotate-left w-5"></i>
                <span class="font-semibold">Riwayat & Driver</span>
            </div>

            <p class="text-[10px] font-bold text-slate-600 uppercase tracking-widest px-4 mt-6 mb-2">Manajemen Data</p>
            <div onclick="switchTab('services')" id="menu-services" class="nav-link">
                <i class="fa-solid fa-spa w-5"></i>
                <span class="font-semibold">Master Harga Massage</span>
            </div>
            <div onclick="switchTab('drivers')" id="menu-drivers" class="nav-link">
                <i class="fa-solid fa-id-card w-5"></i>
                <span class="font-semibold">Data Driver</span>
            </div>
        </nav>
    </aside>

    <main class="flex-1 p-8 overflow-y-auto">
        <div class="max-w-7xl mx-auto">
            
            <!-- SECTION: INPUT TRANSAKSI -->
            <div id="section-transaksi">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold uppercase tracking-tight">Input Transaksi Baru</h2>
                    <p class="text-slate-500 text-sm mt-1">Catat tamu yang dibawa oleh driver ke Delta Spa.</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <div class="lg:col-span-5">
                        <div class="card p-8 rounded-[2.5rem] shadow-2xl border-t-4 border-[#d4af37]">
                            <form id="commission-form" class="space-y-5">
                                <div>
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1">ID Driver (NIK)</label>
                                    <input type="text" id="input-id-driver" placeholder="Ketik ID Driver..." required 
                                        class="w-full p-4 rounded-2xl border border-slate-800 bg-slate-900/50 outline-none mt-1 focus:border-[#d4af37] transition-all">
                                    <p id="id-status" class="text-[10px] mt-1 font-bold h-4"></p>
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1">Nama Driver</label>
                                    <input type="text" id="display-name" placeholder="Terisi otomatis..." readonly 
                                        class="w-full p-4 rounded-2xl border border-slate-800 bg-slate-950/50 opacity-60 outline-none mt-1">
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1">Pilih Paket Massage</label>
                                    <select id="select-service" required class="w-full p-4 rounded-2xl border border-slate-800 outline-none mt-1 bg-slate-900 text-white">
                                        <option value="">Memuat paket...</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1">Total Tamu Diantar</label>
                                    <input type="number" id="guest-count" value="1" min="1" required 
                                        class="w-full p-4 rounded-2xl border border-slate-800 outline-none mt-1 bg-slate-900 text-white">
                                </div>
                                <div class="bg-slate-950/60 p-6 rounded-3xl border border-slate-800/50 space-y-3">
                                    <div class="flex justify-between items-center text-xs text-slate-400">
                                        <span>Harga Massage (Satuan)</span>
                                        <span id="calc-price-unit" class="text-white">Rp 0</span>
                                    </div>
                                    <div class="flex justify-between items-center text-xs text-slate-400">
                                        <span>Total Bayar Tamu (<span id="calc-guest-label">0</span>)</span>
                                        <span id="calc-massage-total" class="font-bold text-white">Rp 0</span>
                                    </div>
                                    <div class="flex justify-between items-center text-xs text-slate-400">
                                        <span>Komisi Driver (Satuan)</span>
                                        <span id="calc-comm-unit" class="text-emerald-500">Rp 0</span>
                                    </div>
                                    <div class="flex justify-between items-center border-t border-slate-800/50 pt-3">
                                        <span class="text-xs text-[#d4af37] font-bold uppercase">Total Komisi Diterima</span>
                                        <span id="calc-total-comm" class="text-xl font-black text-[#d4af37]">Rp 0</span>
                                    </div>
                                </div>
                                <button type="submit" id="btn-save-tr" disabled 
                                    class="w-full gold-gradient py-5 rounded-2xl font-bold opacity-50 cursor-not-allowed transition-all text-white shadow-xl hover:scale-[1.01] uppercase tracking-widest">
                                    SIMPAN & CETAK STRUK
                                </button>
                            </form>
                        </div>
                    </div>
                    <div class="lg:col-span-7 space-y-6">
                        <div class="card p-8 rounded-[2.5rem] flex flex-col justify-center items-center text-center">
                            <div class="w-20 h-20 bg-[#d4af37]/10 rounded-full flex items-center justify-center mb-4">
                                <i class="fa-solid fa-receipt text-[#d4af37] text-3xl"></i>
                            </div>
                            <h4 class="text-xl font-bold uppercase tracking-tight">Cetak Bukti Otomatis</h4>
                            <p class="text-slate-500 max-w-sm mt-2 text-sm">Pastikan printer terhubung. Delta Spa akan langsung menghasilkan struk bukti komisi untuk driver setelah data disimpan.</p>
                        </div>
                        <div class="card p-8 rounded-[2.5rem]">
                            <h4 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4">Tips Operasional</h4>
                            <ul class="text-xs text-slate-500 space-y-2">
                                <li class="flex gap-2"><i class="fa-solid fa-circle-check text-[#d4af37]"></i> Verifikasi ID Driver sesuai KTP sebelum input.</li>
                                <li class="flex gap-2"><i class="fa-solid fa-circle-check text-[#d4af37]"></i> Pastikan jumlah tamu sesuai dengan rombongan yang datang.</li>
                                <li class="flex gap-2"><i class="fa-solid fa-circle-check text-[#d4af37]"></i> Komisi dihitung otomatis berdasarkan master harga paket.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION: RIWAYAT & DRIVER -->
            <div id="section-history" class="hidden">
                <div class="mb-8 flex justify-between items-end">
                    <div>
                        <h2 class="text-3xl font-bold uppercase tracking-tight">Riwayat & Total Driver</h2>
                        <p class="text-slate-500 text-sm mt-1">Pantau driver yang paling sering membawa tamu dan detail komisi.</p>
                    </div>
                    <button onclick="fetchCommissions(); fetchTopDrivers();" class="bg-slate-800 p-3 px-6 rounded-xl text-[#d4af37] hover:bg-slate-700 transition-all font-bold text-xs">
                        <i class="fa-solid fa-arrows-rotate mr-2"></i> REFRESH DATA
                    </button>
                </div>

                <!-- Bagian Performa Driver yang Sering Bawa Tamu -->
                <div class="mb-10">
                    <h3 class="text-xs font-bold text-[#d4af37] uppercase tracking-[0.2em] mb-4">Total Driver & Performa Kunjungan</h3>
                    <div class="card rounded-[2rem] overflow-hidden">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-900 text-slate-500 text-[10px] uppercase tracking-widest">
                                <tr>
                                    <th class="px-6 py-4 text-left">Nama Driver</th>
                                    <th class="px-6 py-4 text-center">Frekuensi Membawa Tamu</th>
                                    <th class="px-6 py-4 text-center">Total Tamu (Jiwa)</th>
                                    <th class="px-6 py-4 text-right">Total Akumulasi Komisi</th>
                                </tr>
                            </thead>
                            <tbody id="top-drivers-body" class="divide-y divide-slate-800/30 text-slate-300">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Log Transaksi Terperinci -->
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-[0.2em] mb-4">Rincian Transaksi Massage & Komisi</h3>
                <div class="card rounded-[2rem] overflow-hidden shadow-2xl">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-900/80 text-slate-500 text-[10px] uppercase tracking-widest">
                                <tr>
                                    <th class="px-6 py-5 text-left">Waktu / Driver</th>
                                    <th class="px-6 py-5 text-left">Paket (Tamu)</th>
                                    <th class="px-6 py-5 text-right">Harga Massage / Total</th>
                                    <th class="px-6 py-5 text-right">Komisi / Tamu</th>
                                    <th class="px-6 py-5 text-right bg-[#d4af37]/5 text-[#d4af37]">Total Komisi</th>
                                </tr>
                            </thead>
                            <tbody id="tr-body" class="divide-y divide-slate-800/30">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SECTION: DATA DRIVER -->
            <div id="section-drivers" class="hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold uppercase tracking-tight">Pangkalan Driver</h2>
                    <p class="text-slate-500 text-sm mt-1">Kelola data mitra pengantar Delta Spa.</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <div class="lg:col-span-4">
                        <div class="card p-8 rounded-[2rem] border-l-4 border-[#d4af37]">
                            <h3 id="driver-form-title" class="text-sm font-bold text-[#d4af37] uppercase tracking-widest mb-6">Pendaftaran Mitra</h3>
                            <form id="driver-reg-form" class="space-y-4">
                                <input type="hidden" id="edit-mode-id">
                                <div>
                                    <label class="text-[9px] font-bold text-slate-500 uppercase ml-1">ID / NIK Driver</label>
                                    <input type="text" id="reg-id" required class="w-full p-4 rounded-xl border border-slate-800 bg-slate-900 outline-none mt-1">
                                </div>
                                <div>
                                    <label class="text-[9px] font-bold text-slate-500 uppercase ml-1">Nama Lengkap</label>
                                    <input type="text" id="reg-name" required class="w-full p-4 rounded-xl border border-slate-800 bg-slate-900 outline-none mt-1">
                                </div>
                                <div>
                                    <label class="text-[9px] font-bold text-slate-500 uppercase ml-1">No. WhatsApp</label>
                                    <input type="tel" id="reg-phone" required class="w-full p-4 rounded-xl border border-slate-800 bg-slate-900 outline-none mt-1">
                                </div>
                                <div>
                                    <label class="text-[9px] font-bold text-slate-500 uppercase ml-1">Alamat Domisili</label>
                                    <textarea id="reg-address" class="w-full p-4 rounded-xl border border-slate-800 bg-slate-900 outline-none mt-1 h-20 text-sm"></textarea>
                                </div>
                                <button type="submit" id="btn-submit-driver" class="w-full gold-gradient py-4 rounded-xl font-bold text-white uppercase tracking-widest shadow-lg">Simpan Driver</button>
                                <button type="button" id="btn-cancel-edit" onclick="resetDriverForm()" class="hidden w-full bg-slate-800 py-3 rounded-xl font-bold text-white uppercase text-xs">Batal</button>
                            </form>
                        </div>
                    </div>
                    <div class="lg:col-span-8">
                        <div class="card rounded-[2rem] overflow-hidden">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-900/50 text-slate-500 text-[10px] uppercase tracking-widest">
                                    <tr>
                                        <th class="px-6 py-4 text-left">Nama Driver</th>
                                        <th class="px-6 py-4 text-left">Kontak & Alamat</th>
                                        <th class="px-6 py-4 text-center">Status</th>
                                        <th class="px-6 py-4 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="driver-body" class="divide-y divide-slate-800/30"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION: MASTER PAKET -->
            <div id="section-services" class="hidden">
                <div class="mb-8 flex justify-between items-end">
                    <div>
                        <h2 class="text-3xl font-bold uppercase tracking-tight">Master Harga & Komisi</h2>
                        <p class="text-slate-500 text-sm mt-1">Konfigurasi harga layanan Delta Spa dan jatah komisi pengantar.</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <div class="lg:col-span-4">
                        <div class="card p-8 rounded-[2rem]">
                            <h3 class="text-sm font-bold text-[#d4af37] uppercase tracking-widest mb-6">Tambah Paket Massage</h3>
                            <form id="service-form" class="space-y-4">
                                <input type="text" id="svc-name" placeholder="Nama Paket (cth: Signature Massage)" required class="w-full p-4 rounded-xl border border-slate-800 bg-slate-900 outline-none">
                                <input type="number" id="svc-price" placeholder="Harga Jual Massage (Rp)" required class="w-full p-4 rounded-xl border border-slate-800 bg-slate-900 outline-none">
                                <input type="number" id="svc-comm" placeholder="Besaran Komisi Driver (Rp)" required class="w-full p-4 rounded-xl border border-slate-800 bg-slate-900 outline-none">
                                <button type="submit" class="w-full gold-gradient py-4 rounded-xl font-bold text-white uppercase tracking-widest">Simpan Layanan</button>
                            </form>
                        </div>
                    </div>
                    <div class="lg:col-span-8">
                        <div class="card rounded-[2rem] overflow-hidden">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-900/50 text-slate-500 text-[10px] uppercase tracking-widest">
                                    <tr>
                                        <th class="px-6 py-4 text-left">Nama Layanan</th>
                                        <th class="px-6 py-4 text-right">Harga Massage</th>
                                        <th class="px-6 py-4 text-right">Komisi Satuan</th>
                                        <th class="px-6 py-4 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="services-list-body" class="divide-y divide-slate-800/30"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        const SUPABASE_URL = "https://qdxchvogaxiibzqvuupf.supabase.co"; 
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkeGNodm9nYXhpaWJ6cXZ1dXBmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxODE5NTIsImV4cCI6MjA4NTc1Nzk1Mn0.8U_zk81b6wFfdZdPRupk5KSk3g39nOPs8SpZVkWbqkc";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let services = [];
        let selectedDriver = null;

        function switchTab(tab) {
            document.querySelectorAll('[id^="section-"]').forEach(s => s.classList.add('hidden'));
            document.getElementById(`section-${tab}`).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
            const menu = document.getElementById(`menu-${tab}`);
            if(menu) menu.classList.add('active');

            if(tab === 'drivers') fetchDrivers();
            if(tab === 'services') loadServices();
            if(tab === 'history') { fetchCommissions(); fetchTopDrivers(); }
        }

        async function loadServices() {
            const { data } = await supabaseClient.from('services').select('*').order('name');
            if (data) {
                services = data;
                document.getElementById('select-service').innerHTML = '<option value="">-- Pilih Paket Massage --</option>' + 
                    data.map(s => `<option value="${s.id}">${s.name} (Rp ${s.price.toLocaleString()})</option>`).join('');
                
                document.getElementById('services-list-body').innerHTML = data.map(s => `
                    <tr>
                        <td class="px-6 py-5 font-bold text-slate-200 uppercase">${s.name}</td>
                        <td class="px-6 py-5 text-right font-mono text-slate-400 italic">Rp ${s.price.toLocaleString()}</td>
                        <td class="px-6 py-5 text-right text-[#d4af37] font-black">Rp ${s.commission.toLocaleString()}</td>
                        <td class="px-6 py-5 text-center">
                            <button onclick="deleteService('${s.id}')" class="text-red-500 opacity-60 hover:opacity-100"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`).join('');
            }
        }

        // Driver Validation Logic
        document.getElementById('input-id-driver').addEventListener('input', async (e) => {
            const id = e.target.value.trim();
            const status = document.getElementById('id-status');
            const btn = document.getElementById('btn-save-tr');
            if(id.length < 2) return;
            const { data } = await supabaseClient.from('drivers').select('*').eq('driver_id', id).single();
            if(data) {
                selectedDriver = data;
                document.getElementById('display-name').value = data.name;
                status.innerText = "✓ Mitra Terdaftar: " + data.name;
                status.className = "text-[10px] mt-1 text-emerald-500 font-bold";
                btn.disabled = false; btn.classList.remove('opacity-50');
            } else {
                selectedDriver = null;
                document.getElementById('display-name').value = "";
                status.innerText = "⚠ Driver Belum Terdaftar";
                status.className = "text-[10px] mt-1 text-red-500 font-bold";
                btn.disabled = true; btn.classList.add('opacity-50');
            }
        });

        // Calculation Logic
        function updateTotals() {
            const svcId = document.getElementById('select-service').value;
            const guests = parseInt(document.getElementById('guest-count').value) || 0;
            const s = services.find(x => x.id == svcId);
            
            document.getElementById('calc-guest-label').innerText = guests + " Tamu";

            if(s && guests > 0) {
                document.getElementById('calc-price-unit').innerText = `Rp ${s.price.toLocaleString()}`;
                document.getElementById('calc-massage-total').innerText = `Rp ${(s.price * guests).toLocaleString()}`;
                document.getElementById('calc-comm-unit').innerText = `Rp ${s.commission.toLocaleString()}`;
                document.getElementById('calc-total-comm').innerText = `Rp ${(s.commission * guests).toLocaleString()}`;
            } else {
                document.getElementById('calc-price-unit').innerText = "Rp 0";
                document.getElementById('calc-massage-total').innerText = "Rp 0";
                document.getElementById('calc-comm-unit').innerText = "Rp 0";
                document.getElementById('calc-total-comm').innerText = "Rp 0";
            }
        }
        document.getElementById('select-service').addEventListener('change', updateTotals);
        document.getElementById('guest-count').addEventListener('input', updateTotals);

        // Save Transaction
        document.getElementById('commission-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!selectedDriver) return;
            const s = services.find(x => x.id == document.getElementById('select-service').value);
            const guests = parseInt(document.getElementById('guest-count').value);
            
            const { error } = await supabaseClient.from('commissions').insert([{
                driver_id: selectedDriver.driver_id,
                driver_name: selectedDriver.name,
                service_id: s.id,
                service_name: s.name,
                massage_guests: guests,
                service_unit_price: s.price,
                total_massage_value: s.price * guests,
                commission_unit: s.commission,
                commission_amount: s.commission * guests
            }]);

            if(!error) {
                document.getElementById('p-date').innerText = new Date().toLocaleString();
                document.getElementById('p-name').innerText = selectedDriver.name;
                document.getElementById('p-service').innerText = s.name;
                document.getElementById('p-guests').innerText = guests;
                document.getElementById('p-rate').innerText = `@ Rp ${s.commission.toLocaleString()}`;
                document.getElementById('p-total').innerText = `Rp ${(s.commission * guests).toLocaleString()}`;
                window.print();
                e.target.reset(); updateTotals();
                alert("Transaksi Delta Spa Disimpan & Struk Dicetak!");
                fetchCommissions(); fetchTopDrivers();
            }
        });

        // Fetch Detailed History
        async function fetchCommissions() {
            const { data } = await supabaseClient.from('commissions').select('*').order('created_at', { ascending: false }).limit(50);
            if(data) {
                document.getElementById('tr-body').innerHTML = data.map(i => `
                    <tr class="hover:bg-slate-800/10">
                        <td class="px-6 py-4">
                            <p class="text-[10px] text-slate-500 font-mono mb-1">${new Date(i.created_at).toLocaleString('id-ID')}</p>
                            <p class="font-bold text-slate-100 uppercase tracking-tight">${i.driver_name}</p>
                        </td>
                        <td class="px-6 py-4">
                            <p class="font-semibold text-white uppercase text-xs">${i.service_name}</p>
                            <p class="text-[10px] text-[#d4af37] font-bold uppercase">${i.massage_guests} Tamu</p>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <p class="text-slate-500 text-[10px]">@ Rp ${(i.service_unit_price || 0).toLocaleString()}</p>
                            <p class="font-bold text-slate-300">Rp ${(i.total_massage_value || 0).toLocaleString()}</p>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <p class="text-xs text-emerald-500 font-bold">Rp ${(i.commission_unit || 0).toLocaleString()}</p>
                        </td>
                        <td class="px-6 py-4 text-right bg-[#d4af37]/5">
                            <p class="text-base font-black text-[#d4af37]">Rp ${i.commission_amount.toLocaleString()}</p>
                        </td>
                    </tr>
                `).join('');
            }
        }

        // Fetch Performance/Top Drivers
        async function fetchTopDrivers() {
            const { data } = await supabaseClient.from('commissions').select('driver_name, driver_id, massage_guests, commission_amount');
            if(data) {
                const stats = {};
                data.forEach(d => {
                    if(!stats[d.driver_id]) stats[d.driver_id] = { name: d.driver_name, visits: 0, guests: 0, total_comm: 0 };
                    stats[d.driver_id].visits += 1;
                    stats[d.driver_id].guests += d.massage_guests;
                    stats[d.driver_id].total_comm += d.commission_amount;
                });
                
                const sorted = Object.values(stats).sort((a,b) => b.visits - a.visits);
                document.getElementById('top-drivers-body').innerHTML = sorted.map(s => `
                    <tr>
                        <td class="px-6 py-4">
                            <p class="font-bold text-white uppercase">${s.name}</p>
                        </td>
                        <td class="px-6 py-4 text-center font-bold text-[#d4af37] italic">${s.visits} Kali Antar</td>
                        <td class="px-6 py-4 text-center">
                            <span class="px-3 py-1 bg-slate-800 rounded-full text-white text-[10px] font-bold tracking-widest">${s.guests} TOTAL TAMU</span>
                        </td>
                        <td class="px-6 py-4 text-right font-black text-emerald-400">Rp ${s.total_comm.toLocaleString()}</td>
                    </tr>
                `).join('');
            }
        }

        // Driver Master Management
        async function fetchDrivers() {
            const { data } = await supabaseClient.from('drivers').select('*').order('name');
            if(data) {
                document.getElementById('driver-body').innerHTML = data.map(d => `
                    <tr>
                        <td class="px-6 py-5">
                            <p class="font-bold text-slate-100 uppercase tracking-tight">${d.name}</p>
                            <p class="text-[10px] text-slate-500">ID: ${d.driver_id}</p>
                        </td>
                        <td class="px-6 py-5">
                            <p class="text-xs text-emerald-500 font-bold mb-1">${d.phone}</p>
                            <p class="text-[10px] text-slate-400 max-w-[200px]">${d.address || '-'}</p>
                        </td>
                        <td class="px-6 py-5 text-center">
                            <span class="bg-emerald-500/10 text-emerald-500 text-[10px] px-2 py-1 rounded-full font-bold uppercase">Aktif</span>
                        </td>
                        <td class="px-6 py-5 text-center">
                            <div class="flex gap-4 justify-center">
                                <button onclick="editDriver('${d.driver_id}')" class="text-blue-400 hover:scale-125 transition-all"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="deleteDriver('${d.driver_id}')" class="text-red-400 hover:scale-125 transition-all"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>`).join('');
            }
        }

        document.getElementById('driver-reg-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const editId = document.getElementById('edit-mode-id').value;
            const payload = {
                driver_id: document.getElementById('reg-id').value,
                name: document.getElementById('reg-name').value,
                phone: document.getElementById('reg-phone').value,
                address: document.getElementById('reg-address').value
            };
            let res;
            if(editId) res = await supabaseClient.from('drivers').update(payload).eq('driver_id', editId);
            else res = await supabaseClient.from('drivers').insert([payload]);
            
            if(!res.error) { resetDriverForm(); fetchDrivers(); alert("Data Driver Delta Spa Diperbarui"); }
        });

        async function editDriver(id) {
            const { data } = await supabaseClient.from('drivers').select('*').eq('driver_id', id).single();
            if(data) {
                document.getElementById('edit-mode-id').value = data.driver_id;
                document.getElementById('reg-id').value = data.driver_id;
                document.getElementById('reg-name').value = data.name;
                document.getElementById('reg-phone').value = data.phone;
                document.getElementById('reg-address').value = data.address || "";
                document.getElementById('driver-form-title').innerText = "Edit Mitra Delta Spa";
                document.getElementById('btn-submit-driver').innerText = "Update Data";
                document.getElementById('btn-cancel-edit').classList.remove('hidden');
                document.getElementById('reg-id').readOnly = true;
            }
        }

        function resetDriverForm() {
            document.getElementById('driver-reg-form').reset();
            document.getElementById('edit-mode-id').value = "";
            document.getElementById('driver-form-title').innerText = "Pendaftaran Mitra";
            document.getElementById('btn-submit-driver').innerText = "Simpan Driver";
            document.getElementById('btn-cancel-edit').classList.add('hidden');
            document.getElementById('reg-id').readOnly = false;
        }

        async function deleteDriver(id) { if(confirm("Hapus driver dari pangkalan?")) { await supabaseClient.from('drivers').delete().eq('driver_id', id); fetchDrivers(); } }
        async function deleteService(id) { if(confirm("Hapus paket massage ini?")) { await supabaseClient.from('services').delete().eq('id', id); loadServices(); } }

        // Initial Boot
        window.onload = () => {
            loadServices();
            fetchCommissions();
            fetchTopDrivers();
        };
    </script>
</body>
</html>
