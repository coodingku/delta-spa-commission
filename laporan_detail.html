<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finex Pos - Laporan Detail Transaksi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Urbanist', sans-serif; background-color: #020617; color: #f8fafc; }
        .card { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(212, 175, 55, 0.1); }
        .sidebar { background: #0f172a; border-right: 1px solid rgba(212, 175, 55, 0.1); }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 14px 20px; border-radius: 16px; color: #94a3b8; transition: 0.3s; margin-bottom: 8px; font-weight: 500; }
        .nav-link:hover { background: rgba(212, 175, 55, 0.05); color: #d4af37; }
        .nav-link.active { background: linear-gradient(135deg, #d4af37 0%, #a67c00 100%); color: white; }
        .gold-text { color: #d4af37; }
        .gold-button { background: linear-gradient(135deg, #d4af37 0%, #a67c00 100%); color: white; }
        .input-dark { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(212, 175, 55, 0.2); color: white; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #d4af37; }

        @media print {
            .no-print { display: none !important; }
            body { background: white !important; color: black !important; }
            .card { border: 1px solid #ddd !important; background: transparent !important; }
        }
    </style>
</head>
<body class="min-h-screen flex">

    <!-- Sidebar -->
    <aside class="w-72 shrink-0 flex flex-col sidebar hidden lg:flex no-print h-screen sticky top-0">
        <div class="p-8 text-center">
            <h1 class="text-2xl font-black italic gold-text tracking-tighter">FINEX <span class="text-white">POS</span></h1>
            <p class="text-[10px] text-slate-500 font-bold tracking-[0.2em] mt-1 uppercase">BeautyBloom Management</p>
            <div class="h-px bg-gradient-to-r from-transparent via-[#d4af37]/50 to-transparent my-4"></div>
        </div>
        <nav class="flex-1 px-4">
            <a href="dashboard.html" class="nav-link"><i class="fa-solid fa-chart-line w-5"></i> Dashboard</a>
            <a href="rekap_driver.html" class="nav-link"><i class="fa-solid fa-users-gear w-5"></i> Rekap Driver</a>
            <a href="#" class="nav-link active"><i class="fa-solid fa-list-check w-5"></i> Laporan Detail</a>
            <a href="#" class="nav-link"><i class="fa-solid fa-history w-5"></i> Log Transaksi</a>
        </nav>
    </aside>

    <main class="flex-1 p-6 md:p-10 overflow-hidden">
        <div class="max-w-[1700px] mx-auto">
            
            <header class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-3xl font-black uppercase italic gold-text">Detail <span class="text-white">Transaksi Komprehensif</span></h1>
                    <p class="text-slate-500 text-sm italic font-medium">Audit harian: Driver, Jenis Tamu (Lokal/Asing), Poin, dan Komisi</p>
                </div>
                <div class="flex flex-wrap gap-2 no-print">
                    <button onclick="exportToPDF()" class="px-4 py-2 bg-rose-600/20 text-rose-400 border border-rose-600/30 rounded-lg text-xs font-bold hover:bg-rose-600 hover:text-white transition-all flex items-center gap-2">
                        <i class="fa-solid fa-file-pdf"></i> PDF
                    </button>
                    <button onclick="exportToExcel()" class="px-4 py-2 bg-emerald-600/20 text-emerald-400 border border-emerald-600/30 rounded-lg text-xs font-bold hover:bg-emerald-600 hover:text-white transition-all flex items-center gap-2">
                        <i class="fa-solid fa-file-excel"></i> EXCEL
                    </button>
                </div>
            </header>

            <!-- Filter Section -->
            <div class="card p-6 rounded-2xl mb-8 no-print border-l-4 border-l-[#d4af37]">
                <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                    <div class="flex flex-col gap-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Periode Awal</label>
                        <input type="date" id="filter-start" class="input-dark px-4 py-2.5 rounded-xl text-sm">
                    </div>
                    <div class="flex flex-col gap-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Periode Akhir</label>
                        <input type="date" id="filter-end" class="input-dark px-4 py-2.5 rounded-xl text-sm">
                    </div>
                    <div class="flex flex-col gap-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Kategori Tamu</label>
                        <select id="filter-category" class="input-dark px-4 py-2.5 rounded-xl text-sm outline-none">
                            <option value="">Semua Kategori</option>
                            <option value="lokal">Lokal</option>
                            <option value="asing">Asing</option>
                        </select>
                    </div>
                    <div class="md:col-span-2 flex flex-col gap-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Pencarian Universal</label>
                        <input type="text" id="filter-search" placeholder="Cari Nama Driver, Tamu, Paket..." class="input-dark px-4 py-2.5 rounded-xl text-sm w-full uppercase font-bold italic">
                    </div>
                    <div class="flex items-end">
                        <button onclick="fetchDetailData()" class="w-full py-2.5 gold-button rounded-xl text-xs font-black uppercase tracking-widest hover:brightness-110 transition-all shadow-lg shadow-[#d4af37]/20">
                            PROSES DATA
                        </button>
                    </div>
                </div>
            </div>

            <!-- Table Container -->
            <div class="card rounded-3xl overflow-hidden shadow-2xl border border-white/5">
                <div class="overflow-x-auto">
                    <table id="detail-table" class="w-full text-sm">
                        <thead>
                            <tr class="bg-slate-900/90 text-slate-500 text-[10px] uppercase tracking-widest font-black border-b border-white/5">
                                <th class="px-6 py-5 text-left">Waktu</th>
                                <th class="px-6 py-5 text-left">Driver</th>
                                <th class="px-6 py-5 text-left">Tamu & Paket</th>
                                <th class="px-6 py-5 text-center">Asal Tamu</th>
                                <th class="px-6 py-5 text-center">Pax</th>
                                <th class="px-6 py-5 text-right">Harga (S)</th>
                                <th class="px-6 py-5 text-right">Total Harga</th>
                                <th class="px-6 py-5 text-center">Poin</th>
                                <th class="px-6 py-5 text-right gold-text bg-white/5">Total Komisi</th>
                            </tr>
                        </thead>
                        <tbody id="detail-body" class="text-slate-300 divide-y divide-slate-800/50">
                            <tr><td colspan="9" class="p-20 text-center text-slate-600 italic tracking-widest uppercase text-xs">Pilih rentang tanggal dan klik Proses Data</td></tr>
                        </tbody>
                        <tfoot class="bg-slate-950/80 border-t-2 border-slate-800">
                            <tr class="font-black text-white italic">
                                <td colspan="3" class="px-6 py-6 text-right uppercase text-[10px] text-slate-500 tracking-widest">Total Akumulasi Periode</td>
                                <td id="foot-category-summary" class="px-6 py-6 text-center text-[10px] uppercase leading-tight text-slate-400">
                                    L: <span id="total-lokal" class="text-white">0</span> | A: <span id="total-asing" class="text-white">0</span>
                                </td>
                                <td id="foot-total-pax" class="px-6 py-6 text-center text-lg text-white">-</td>
                                <td class="px-6 py-6 text-right">-</td>
                                <td id="foot-total-price" class="px-6 py-6 text-right text-lg text-white">-</td>
                                <td id="foot-total-points" class="px-6 py-6 text-center text-lg text-orange-400">-</td>
                                <td id="foot-total-comm" class="px-6 py-6 text-right gold-text text-xl bg-white/5">-</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        const SUPABASE_URL = "https://qdxchvogaxiibzqvuupf.supabase.co"; 
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkeGNodm9nYXhpaWJ6cXZ1dXBmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxODE5NTIsImV4cCI6MjA4NTc1Nzk1Mn0.8U_zk81b6wFfdZdPRupk5KSk3g39nOPs8SpZVkWbqkc";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentData = [];

        async function fetchDetailData() {
            const start = document.getElementById('filter-start').value;
            const end = document.getElementById('filter-end').value;
            const search = document.getElementById('filter-search').value.toLowerCase();
            const catFilter = document.getElementById('filter-category').value;
            const body = document.getElementById('detail-body');

            if(!start || !end) return;

            body.innerHTML = `<tr><td colspan="9" class="p-20 text-center text-slate-500 animate-pulse uppercase font-black italic tracking-widest">Mengambil Data...</td></tr>`;

            try {
                const { data, error } = await supabaseClient
                    .from('commissions')
                    .select('*')
                    .gte('created_at', start + 'T00:00:00')
                    .lte('created_at', end + 'T23:59:59')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Filter logic
                currentData = data.filter(item => {
                    const driver = (item.driver_name || '').toLowerCase();
                    const guest = (item.guest_name || '').toLowerCase();
                    const package = (item.package_name || '').toLowerCase();
                    const guestType = (item.guest_type || 'lokal').toLowerCase(); // Field: guest_type

                    const matchesSearch = driver.includes(search) || guest.includes(search) || package.includes(search);
                    const matchesCategory = catFilter === "" || guestType === catFilter;

                    return matchesSearch && matchesCategory;
                });

                renderDetailTable(currentData);

            } catch (err) {
                console.error(err);
                body.innerHTML = `<tr><td colspan="9" class="p-20 text-center text-red-500 font-bold uppercase">Koneksi Error: ${err.message}</td></tr>`;
            }
        }

        function renderDetailTable(list) {
            const body = document.getElementById('detail-body');
            if (list.length === 0) {
                body.innerHTML = `<tr><td colspan="9" class="p-20 text-center text-slate-700 font-black uppercase italic tracking-widest">Data Kosong</td></tr>`;
                resetTotals();
                return;
            }

            let tPax = 0, tPrice = 0, tPoints = 0, tComm = 0;
            let countLokal = 0, countAsing = 0;

            body.innerHTML = list.map(item => {
                const dateObj = new Date(item.created_at);
                const jam = dateObj.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                const tgl = dateObj.toLocaleDateString('id-ID', { day: '2-digit', month: 'short' });
                
                const pax = parseInt(item.massage_guests) || 0;
                const totalPrice = parseInt(item.total_massage_value) || 0;
                const points = parseInt(item.points_earned) || 0; 
                const totalComm = parseInt(item.commission_amount) || 0;
                const guestType = (item.guest_type || 'lokal').toLowerCase(); 

                const hargaSatuan = pax > 0 ? Math.round(totalPrice / pax) : 0;

                tPax += pax;
                tPrice += totalPrice;
                tPoints += points;
                tComm += totalComm;

                if(guestType === 'asing') countAsing += pax;
                else countLokal += pax;

                const badgeClass = guestType === 'asing' 
                    ? 'bg-blue-500/10 text-blue-400 border-blue-500/20' 
                    : 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20';

                return `
                    <tr class="hover:bg-white/5 transition-all group">
                        <td class="px-6 py-4">
                            <div class="text-white font-bold">${jam}</div>
                            <div class="text-[10px] text-slate-500 uppercase">${tgl}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="font-black text-slate-200 uppercase italic tracking-tighter">${item.driver_name || 'N/A'}</div>
                            <div class="text-[10px] text-slate-500 font-mono">${item.driver_id || '-'}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="font-bold text-white text-xs uppercase">${item.package_name || 'SERVICE'}</div>
                            <div class="text-[10px] text-slate-400 italic">Tamu: ${item.guest_name || 'Guest'}</div>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="px-3 py-1 rounded-full text-[9px] font-black uppercase border ${badgeClass}">
                                ${guestType}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-center font-bold text-white">${pax}</td>
                        <td class="px-6 py-4 text-right text-slate-500 font-mono text-xs">Rp ${hargaSatuan.toLocaleString('id-ID')}</td>
                        <td class="px-6 py-4 text-right text-white font-bold font-mono">Rp ${totalPrice.toLocaleString('id-ID')}</td>
                        <td class="px-6 py-4 text-center">
                            <span class="px-2 py-1 bg-orange-500/10 text-orange-400 rounded text-[10px] font-black border border-orange-500/20">
                                <i class="fa-solid fa-star text-[8px] mr-1"></i>${points}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-right font-black gold-text italic text-base bg-white/[0.02] group-hover:bg-white/5 transition-all">
                            Rp ${totalComm.toLocaleString('id-ID')}
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('foot-total-pax').innerText = tPax;
            document.getElementById('foot-total-price').innerText = `Rp ${tPrice.toLocaleString('id-ID')}`;
            document.getElementById('foot-total-points').innerText = `${tPoints}`;
            document.getElementById('foot-total-comm').innerText = `Rp ${tComm.toLocaleString('id-ID')}`;
            document.getElementById('total-lokal').innerText = countLokal;
            document.getElementById('total-asing').innerText = countAsing;
        }

        function resetTotals() {
            ['foot-total-pax', 'foot-total-price', 'foot-total-points', 'foot-total-comm', 'total-lokal', 'total-asing'].forEach(id => {
                document.getElementById(id).innerText = "0";
            });
        }

        function exportToExcel() {
            if(currentData.length === 0) return;
            const table = document.getElementById("detail-table");
            const wb = XLSX.utils.table_to_book(table, { sheet: "Laporan_Detail" });
            XLSX.writeFile(wb, `Detail_Transaksi_FinexPos_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportToPDF() {
            if(currentData.length === 0) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a3');
            
            doc.setFontSize(20);
            doc.setTextColor(190, 155, 50);
            doc.text('FINEX POS - DETAIL TRANSAKSI LOKAL & ASING', 14, 20);
            
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`Periode: ${document.getElementById('filter-start').value} s/d ${document.getElementById('filter-end').value}`, 14, 28);

            const headers = [["Waktu", "Driver", "Tamu", "Paket", "Kategori", "Pax", "Total Harga", "Poin", "Total Komisi"]];
            const data = currentData.map(item => [
                new Date(item.created_at).toLocaleString('id-ID'),
                item.driver_name,
                item.guest_name,
                item.package_name,
                (item.guest_type || 'lokal').toUpperCase(),
                item.massage_guests,
                parseInt(item.total_massage_value).toLocaleString('id-ID'),
                item.points_earned || 0,
                parseInt(item.commission_amount).toLocaleString('id-ID')
            ]);

            doc.autoTable({
                head: headers,
                body: data,
                startY: 35,
                theme: 'grid',
                headStyles: { fillColor: [15, 23, 42], textColor: [212, 175, 55] },
            });

            doc.save(`Laporan_Detail_FinexPos.pdf`);
        }

        window.onload = () => {
            const now = new Date();
            document.getElementById('filter-start').value = now.toISOString().split('T')[0];
            document.getElementById('filter-end').value = now.toISOString().split('T')[0];
            fetchDetailData();
        };
    </script>
</body>
</html>
